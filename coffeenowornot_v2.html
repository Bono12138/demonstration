<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å’–å•¡å› ä»£è°¢è®¡ç®—å™¨ â˜•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        coffee: {
                            light: '#e6d2b5',
                            DEFAULT: '#c8a985',
                            dark: '#8b6b4e',
                        },
                        cream: '#f8f0e3',
                        accent: '#d97706',
                    },
                    fontFamily: {
                        sans: ['Nunito', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .shadow-soft {
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            }
            .animate-float {
                animation: float 3s ease-in-out infinite;
            }
            @keyframes float {
                0% { transform: translateY(0px); }
                50% { transform: translateY(-10px); }
                100% { transform: translateY(0px); }
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-cream min-h-screen font-sans text-gray-800">
    <div class="container mx-auto px-4 py-8 max-w-2xl">
        <!-- æ ‡é¢˜åŒºåŸŸ -->
        <header class="text-center mb-10">
            <h1 class="text-[clamp(2rem,5vw,3rem)] font-bold text-coffee-dark mb-2">
                â˜• å’–å•¡å› ä»£è°¢è®¡ç®—å™¨
            </h1>
            <p class="text-gray-600 text-lg">è®°å½•ä½ çš„å’–å•¡ï¼ŒæŒæ¡æ¸…é†’æ—¶é—´ âœ¨</p>
        </header>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <main class="bg-white rounded-2xl shadow-soft p-6 mb-8">
            <!-- å’–å•¡è¾“å…¥åŒºåŸŸ -->
            <section class="mb-8">
                <h2 class="text-xl font-semibold text-coffee-dark mb-4 flex items-center">
                    <i class="fa fa-plus-circle text-accent mr-2"></i> æ·»åŠ å’–å•¡
                </h2>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label for="coffee-time" class="block text-sm font-medium text-gray-700 mb-1">
                            é¥®ç”¨æ—¶é—´ â°
                        </label>
                        <input type="datetime-local" id="coffee-time" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-coffee transition-all">
                    </div>
                    
                    <div>
                        <label for="coffee-amount" class="block text-sm font-medium text-gray-700 mb-1">
                            å’–å•¡å› å«é‡ (mg) â˜•
                        </label>
                        <select id="coffee-amount" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-coffee transition-all">
                            <option value="30" selected>å°‘é‡ (30mg) - ä¸€å°æ¯æ‹¿é“</option>
                            <option value="80">ä¸­é‡ (80mg) - ä¸€æ¯ç¾å¼</option>
                            <option value="150">å¤§é‡ (150mg) - ä¸€æ¯æµ“ç¼©</option>
                            <option value="200">è¶…å¤§é‡ (200mg) - èƒ½é‡é¥®æ–™</option>
                            <option value="custom">è‡ªå®šä¹‰...</option>
                        </select>
                        <input type="number" id="custom-amount" placeholder="è¾“å…¥æ¯«å…‹æ•°" min="1"
                            class="w-full mt-2 px-3 py-2 border border-gray-300 rounded-lg hidden focus:outline-none focus:ring-2 focus:ring-coffee transition-all">
                    </div>
                </div>
                
                <button id="add-coffee" class="mt-4 bg-coffee hover:bg-coffee-dark text-white py-2 px-6 rounded-full transition-all transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-coffee focus:ring-offset-2">
                    <i class="fa fa-coffee mr-1"></i> æ·»åŠ 
                </button>
            </section>
            
            <!-- å’–å•¡åˆ—è¡¨åŒºåŸŸ -->
            <section class="mb-8">
                <h2 class="text-xl font-semibold text-coffee-dark mb-4 flex items-center">
                    <i class="fa fa-list-alt text-accent mr-2"></i> ä½ çš„å’–å•¡è®°å½•
                </h2>
                
                <div id="coffee-list" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                    <p class="text-gray-500 italic text-center py-4">è¿˜æ²¡æœ‰æ·»åŠ å’–å•¡å“¦~</p>
                </div>
            </section>
            
            <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
            <section>
                <h2 class="text-xl font-semibold text-coffee-dark mb-4 flex items-center">
                    <i class="fa fa-clock-o text-accent mr-2"></i> ä»£è°¢ç»“æœ
                </h2>
                
                <div id="result" class="bg-coffee-light/30 rounded-xl p-4 text-center hidden">
                    <p class="text-lg mb-2">ä½“å†…å’–å•¡å› å°†åœ¨ <span id="all-clear-time" class="font-bold text-accent text-xl"></span> é™ä½è‡³ä¸å½±å“ç¡çœ çš„æµ“åº¦</p>
                    <p id="current-level" class="text-md mb-2">å½“å‰ä¼°ç®—å’–å•¡å› æ°´å¹³: <span class="font-bold"></span></p>
                    <p id="status-message" class="mt-3 text-lg"></p>
                </div>
                
                <div id="no-coffee-message" class="bg-coffee-light/30 rounded-xl p-4 text-center">
                    <p class="text-gray-500">æ·»åŠ å’–å•¡åå°†æ˜¾ç¤ºä»£è°¢æ—¶é—´å“¦~</p>
                </div>
            </section>
        </main>
        
        <!-- æ™ºèƒ½æ¨èåŒºåŸŸ -->
        <section class="bg-white rounded-2xl shadow-soft p-6 mb-8">
            <h2 class="text-xl font-semibold text-coffee-dark mb-4 flex items-center">
                <i class="fa fa-lightbulb-o text-accent mr-2"></i> æ™ºèƒ½æ¨è
            </h2>

            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label for="rest-time" class="block text-sm font-medium text-gray-700 mb-1">
                        å‡†å¤‡ä¼‘æ¯æ—¶é—´ ğŸ›Œï¼ˆé»˜è®¤ 24:00ï¼‰
                    </label>
                    <input type="datetime-local" id="rest-time" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-coffee transition-all">
                </div>
            </div>

            <p class="text-xs text-gray-500 mt-2">è‹¥æœªæ·»åŠ ä»»ä½•è®°å½•ï¼Œå°†æŒ‰é»˜è®¤å·²æ‘„å…¥ï¼šä»Šå¤© 09:00 ä¸€å°æ¯æ‹¿é“ 30mg è¿›è¡Œè®¡ç®—ã€‚</p>

            <button id="get-recommendation" class="mt-4 bg-coffee hover:bg-coffee-dark text-white py-2 px-6 rounded-full transition-all transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-coffee focus:ring-offset-2">
                <i class="fa fa-magic mr-1"></i> è·å–æ¨è
            </button>

            <div id="recommendation-result" class="mt-4 bg-coffee-light/30 rounded-xl p-4 text-center text-gray-700">
                <p class="text-gray-500">è®¾ç½®ä¼‘æ¯æ—¶é—´åç‚¹å‡»â€œè·å–æ¨èâ€ï½</p>
            </div>
        </section>
        
        <!-- ä¿¡æ¯è¯´æ˜åŒºåŸŸ -->
        <section class="bg-white rounded-2xl shadow-soft p-5 mb-8">
            <h3 class="font-semibold text-coffee-dark mb-2 flex items-center">
                <i class="fa fa-info-circle text-accent mr-2"></i> å°çŸ¥è¯†
            </h3>
            <p class="text-sm text-gray-600 mb-2">å’–å•¡å› çš„åŠè¡°æœŸçº¦ä¸º4å°æ—¶ï¼Œå³æ¯è¿‡4å°æ—¶ï¼Œä½“å†…çš„å’–å•¡å› å«é‡ä¼šå‡å°‘ä¸€åŠã€‚</p>
            <p class="text-sm text-gray-600">è®¡ç®—ç»“æœä»…ä¾›å‚è€ƒï¼Œå®é™…ä»£è°¢æƒ…å†µå› äººè€Œå¼‚å“¦~</p>
        </section>
        
        <!-- é¡µè„š -->
        <footer class="text-center text-gray-500 text-sm">
            <p>â˜• å¥½å¥½äº«å—å’–å•¡æ—¶å…‰ï¼Œä½†ä¹Ÿè¦æ³¨æ„ä¼‘æ¯å“¦~ â˜•</p>
        </footer>
    </div>
    
    <!-- æç¤ºå¼¹çª— -->
    <div id="alert-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 transform transition-all animate-float">
            <div class="text-center">
                <div class="text-5xl mb-4">ğŸ˜±</div>
                <h3 class="text-xl font-bold text-coffee-dark mb-2">å’–å•¡è¿‡é‡æé†’</h3>
                <p class="text-gray-700 mb-6">"ç­æ˜¯å…¬å¸çš„ï¼Œå‘½æ˜¯è‡ªå·±çš„ï¼Œä¸è¡Œå’±å°±æ­‡æ­‡å§å°åŒå¿—~"</p>
                <button id="close-alert" class="bg-accent hover:bg-amber-700 text-white py-2 px-6 rounded-full transition-all">
                    çŸ¥é“å•¦~
                </button>
            </div>
        </div>
    </div>

    <script>
        // å­˜å‚¨å’–å•¡æ•°æ®çš„æ•°ç»„
        let coffees = [];
        const HALF_LIFE_HOURS = 4;
        const CLEAR_THRESHOLD = 20; // ä½äºæ­¤å€¼è§†ä¸ºå®‰å…¨ï¼Œä¸å½±å“ç¡çœ  (mg)
        
        // DOM å…ƒç´ 
        const coffeeTimeInput = document.getElementById('coffee-time');
        const coffeeAmountSelect = document.getElementById('coffee-amount');
        const customAmountInput = document.getElementById('custom-amount');
        const addCoffeeButton = document.getElementById('add-coffee');
        const coffeeListElement = document.getElementById('coffee-list');
        const resultElement = document.getElementById('result');
        const noCoffeeMessage = document.getElementById('no-coffee-message');
        const allClearTimeElement = document.getElementById('all-clear-time');
        const currentLevelElement = document.querySelector('#current-level span');
        const statusMessageElement = document.getElementById('status-message');
        const alertModal = document.getElementById('alert-modal');
        const closeAlertButton = document.getElementById('close-alert');
        const restTimeInput = document.getElementById('rest-time');
        const getRecommendationButton = document.getElementById('get-recommendation');
        const recommendationResult = document.getElementById('recommendation-result');
        
        // åˆå§‹åŒ–è®¾ç½®å½“å‰æ—¶é—´ - é»˜è®¤ä¸ºå½“æ—¥09:00
        function setDefaultTime() {
            const d = new Date();
            d.setHours(9, 0, 0, 0); // è®¾ç½®ä¸ºå½“æ—¥09:00
            coffeeTimeInput.value = toLocalInputValue(d);
        }
        
        // åˆå§‹åŒ–ä¼‘æ¯æ—¶é—´é»˜è®¤å€¼ï¼ˆå½“æ—¥ 23:59ï¼‰
        function setDefaultRestTime() {
            const now = new Date();
            now.setHours(23, 59, 0, 0); // è®¾ç½®ä¸ºå½“æ—¥23:59
            restTimeInput.value = toLocalInputValue(now);
        }

        function toLocalInputValue(d) {
            const p = n => String(n).padStart(2, '0');
            return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`;
        }
        
        // æ˜¾ç¤º/éšè—è‡ªå®šä¹‰è¾“å…¥æ¡†
        coffeeAmountSelect.addEventListener('change', () => {
            if (coffeeAmountSelect.value === 'custom') {
                customAmountInput.classList.remove('hidden');
                customAmountInput.required = true;
            } else {
                customAmountInput.classList.add('hidden');
                customAmountInput.required = false;
            }
        });
        
        // æ·»åŠ å’–å•¡
        addCoffeeButton.addEventListener('click', () => {
            const time = new Date(coffeeTimeInput.value);
            let amount;
            
            if (coffeeAmountSelect.value === 'custom') {
                amount = parseInt(customAmountInput.value);
                if (isNaN(amount) || amount <= 0) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å’–å•¡å› å«é‡');
                    return;
                }
            } else {
                amount = parseInt(coffeeAmountSelect.value);
            }
            
            // æ·»åŠ åˆ°æ•°ç»„
            coffees.push({
                id: Date.now(),
                time: time,
                amount: amount
            });
            
            // æ£€æŸ¥æ˜¯å¦è¿‡é‡ (è¶…è¿‡ 600mg è§†ä¸ºè¿‡é‡)
            const totalAmount = coffees.reduce((sum, coffee) => sum + coffee.amount, 0);
            if (totalAmount > 600) {
                alertModal.classList.remove('hidden');
            }
            
            // æ›´æ–°æ˜¾ç¤º
            updateCoffeeList();
            calculateAndDisplayResults();
            
            // ä¸é‡ç½®ç”¨æˆ·é€‰æ‹©ï¼Œä»…åœ¨è‡ªå®šä¹‰æ¨¡å¼ä¸‹æ¸…ç©ºè‡ªå®šä¹‰è¾“å…¥æ¡†
            if (coffeeAmountSelect.value === 'custom') {
                customAmountInput.value = '';
            }
        });
        
        // å…³é—­å¼¹çª—
        closeAlertButton.addEventListener('click', () => {
            alertModal.classList.add('hidden');
        });
        
        // æ›´æ–°å’–å•¡åˆ—è¡¨
        function updateCoffeeList() {
            if (coffees.length === 0) {
                coffeeListElement.innerHTML = '<p class="text-gray-500 italic text-center py-4">è¿˜æ²¡æœ‰æ·»åŠ å’–å•¡å“¦~</p>';
                return;
            }
            
            // æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            coffees.sort((a, b) => b.time - a.time);
            
            coffeeListElement.innerHTML = '';
            
            coffees.forEach(coffee => {
                const coffeeItem = document.createElement('div');
                coffeeItem.className = 'bg-cream rounded-lg p-3 flex justify-between items-center';
                
                const timeStr = formatDateTime(coffee.time);
                const emoji = getCoffeeEmoji(coffee.amount);
                
                coffeeItem.innerHTML = `
                    <div>
                        <p class="font-medium">${emoji} ${coffee.amount} mg</p>
                        <p class="text-sm text-gray-500">${timeStr}</p>
                    </div>
                    <button class="delete-coffee text-gray-400 hover:text-red-500 transition-colors" data-id="${coffee.id}">
                        <i class="fa fa-trash-o"></i>
                    </button>
                `;
                
                coffeeListElement.appendChild(coffeeItem);
            });
            
            // æ·»åŠ åˆ é™¤äº‹ä»¶ç›‘å¬
            document.querySelectorAll('.delete-coffee').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = parseInt(e.currentTarget.dataset.id);
                    coffees = coffees.filter(coffee => coffee.id !== id);
                    updateCoffeeList();
                    calculateAndDisplayResults();
                });
            });
        }
        
        // è®¡ç®—å¹¶æ˜¾ç¤ºç»“æœ - ä¿®å¤åçš„é€»è¾‘
        function calculateAndDisplayResults() {
            if (coffees.length === 0) {
                resultElement.classList.add('hidden');
                noCoffeeMessage.classList.remove('hidden');
                return;
            }
            
            resultElement.classList.remove('hidden');
            noCoffeeMessage.classList.add('hidden');
            
            // è®¡ç®—å½“å‰ä½“å†…å’–å•¡å› æ€»é‡
            const now = new Date();
            let currentTotal = 0;
            
            coffees.forEach(coffee => {
                const hoursPassed = (now - coffee.time) / (1000 * 60 * 60);
                if (hoursPassed >= 0) {
                    // è®¡ç®—å‰©ä½™é‡ï¼šåˆå§‹é‡ Ã— (0.5)^(å°æ—¶æ•°/åŠè¡°æœŸ)
                    currentTotal += coffee.amount * Math.pow(0.5, hoursPassed / HALF_LIFE_HOURS);
                }
            });
            
            // æ˜¾ç¤ºå½“å‰å’–å•¡å› æ°´å¹³
            currentLevelElement.textContent = Math.round(currentTotal) + ' mg';
            
            // è®¡ç®—é™ä½è‡³ä¸å½±å“ç¡çœ çš„æµ“åº¦æ—¶é—´ï¼ˆè€ƒè™‘æ‰€æœ‰å’–å•¡çš„ç´¯ç§¯æ•ˆåº”ï¼‰
            let allClearTime = calculateCompleteClearanceTime();
            
            // æ˜¾ç¤ºç»“æœ
            allClearTimeElement.textContent = formatDateTime(allClearTime);
            
            // è®¾ç½®çŠ¶æ€æ¶ˆæ¯å’Œemoji
            setStatusMessage(allClearTime);
        }

        // è®¡ç®—æŒ‡å®šæ—¶é—´ç‚¹ä½“å†…å’–å•¡å› æ€»é‡
        function computeTotalAt(targetTime, coffeeEvents) {
            let total = 0;
            coffeeEvents.forEach(coffee => {
                const hoursPassed = (targetTime - coffee.time) / (1000 * 60 * 60);
                if (hoursPassed >= 0) {
                    total += coffee.amount * Math.pow(0.5, hoursPassed / HALF_LIFE_HOURS);
                }
            });
            return total;
        }

        // æ¨èå€™é€‰
        const PRODUCT_OPTIONS = [
            { key: 'free', label: 'æ—¶é—´å……è£•ï¼Œéšä¾¿å–', mg: 90, url: 'http://dpurl.cn/gmH3136z' },
            { key: 'control', label: 'æ§åˆ¶ä¸‹ï¼Œå°±ä¸€æ¯', mg: 60, url: 'http://dpurl.cn/n2BgC4Uz' },
            { key: 'stop', label: 'ä¸èƒ½å–å’–å•¡äº†å“¦ï¼Œå†å–å½±å“ä¼‘æ¯äº†å“¦', mg: 20, url: 'http://dpurl.cn/EUAfDSaz' }
        ];

        const PRODUCT_XPATH = {
            image: '//*[@id="detailPage"]/mt-view/mt-view/mt-view/mt-view/mt-view/u-banner/mt-view/mt-view/mt-swiper/div/div[1]/div/mt-swiper-item/u-mp-img/mt-view/mt-image/div',
            name: '//*[@id="goodsInfo"]/u-gooditeminfo/mt-view[1]/mt-view/mt-view[2]/mt-text'
        };

        async function getRecommendation() {
            // ä¼‘æ¯æ—¶é—´
            const restTime = restTimeInput.value ? new Date(restTimeInput.value) : (() => {
                const d = new Date(); d.setHours(23,59,0,0); return d;
            })();

            // è®¡ç®—åŸºå‡†å’–å•¡åˆ—è¡¨ï¼šè‹¥æ²¡æœ‰è®°å½•ï¼Œé»˜è®¤ä»Šå¤© 09:00 30mgï¼ˆä¸€å°æ¯æ‹¿é“ï¼‰
            const baseCoffees = coffees.length > 0 ? coffees : (() => {
                const d = new Date(); d.setHours(9, 0, 0, 0);
                return [{ time: d, amount: 30 }];
            })();

            const now = new Date();

            // ä¾æ¬¡å°è¯•ä»å¤§åˆ°å°çš„å€™é€‰ï¼Œå¯»æ‰¾åœ¨ä¼‘æ¯æ—¶é—´æ€»é‡ä¸è¶…è¿‡é˜ˆå€¼çš„æœ€å¤§æ¨è
            let chosen = null;
            for (const option of PRODUCT_OPTIONS) {
                const testEvents = [
                    ...baseCoffees.map(c => ({ time: new Date(c.time), amount: c.amount })),
                    { time: now, amount: option.mg }
                ];
                const totalAtRest = computeTotalAt(restTime, testEvents);
                if (totalAtRest <= CLEAR_THRESHOLD) {
                    chosen = option;
                    break;
                }
            }

            // è‹¥å…¨éƒ¨ä¸æ»¡è¶³ï¼Œåˆ™æç¤ºä¸å»ºè®®å†æ‘„å…¥ï¼ˆä»å±•ç¤ºâ€œä¸èƒ½å–â€å¡ç‰‡ï¼Œä½†æ ‡è®°ä¸ºä¸æ¨èï¼‰
            if (!chosen) {
                chosen = { ...PRODUCT_OPTIONS[2], notRecommended: true };
            }

            // å°è¯•æŠ“å–äº§å“ä¿¡æ¯ï¼ˆåç§°ä¸å›¾ç‰‡ï¼‰
            const info = await fetchProductInfo(chosen.url).catch(() => null);
            updateRecommendationUI({ ...chosen, productName: info?.name, productImage: info?.image });
        }

        async function fetchProductInfo(url) {
            try {
                // ä½¿ç”¨ CORS ä»£ç†ä»¥è§„é¿è·¨åŸŸé™åˆ¶ï¼ˆåªè¯»ã€å…¬å…±ä»£ç†ï¼›è‹¥å¤±æ•ˆå°†å›é€€ï¼‰
                const proxied = `https://r.jina.ai/http://cors.isomorphic-git.org/${encodeURIComponent(url)}`;
                const resp = await fetch(proxied, { method: 'GET' });
                if (!resp.ok) throw new Error('proxy-failed');
                const html = await resp.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // å¤šé€‰æ‹©å™¨å…œåº•ï¼Œä¼˜å…ˆä½¿ç”¨æä¾›çš„ XPath
                let name = '';
                try {
                    const nameNode = doc.evaluate(PRODUCT_XPATH.name, doc, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
                    if (nameNode) name = (nameNode.textContent || nameNode.getAttribute('title') || '').trim();
                } catch {}
                if (!name) {
                    const titleEl = doc.querySelector('h1, h2, [class*="title"], [class*="goods"], [class*="name"]');
                    if (titleEl) name = titleEl.textContent.trim();
                }

                let image = '';
                try {
                    const imageNode = doc.evaluate(PRODUCT_XPATH.image, doc, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
                    if (imageNode) {
                        const imgEl = imageNode.querySelector && imageNode.querySelector('img');
                        if (imgEl && (imgEl.src || imgEl.getAttribute('src'))) image = imgEl.src || imgEl.getAttribute('src');
                        if (!image) {
                            const bg = imageNode.getAttribute && imageNode.getAttribute('style');
                            if (bg) {
                                const match = bg.match(/url\(([^)]+)\)/i);
                                if (match && match[1]) image = match[1].replace(/['"]/g, '');
                            }
                        }
                    }
                } catch {}
                if (!image) {
                    const firstImg = doc.querySelector('img');
                    if (firstImg) image = firstImg.src || firstImg.getAttribute('src') || '';
                }

                if (!name && !image) throw new Error('no-data');
                return { name, image };
            } catch (e) {
                // å…œåº•é™æ€æ˜ å°„
                const m = {
                    'gmH3136z': { name: 'æ¡ƒæ¡ƒå†°èŒ¶å…‘æ¢åˆ¸Â·1å¼ ', image: null },
                    'n2BgC4Uz': { name: 'æ§åˆ¶æ¬¾å’–å•¡äº§å“', image: null },
                    'EUAfDSaz': { name: 'ä½å’–å•¡å› äº§å“', image: null }
                };
                for (const k in m) {
                    if (url.includes(k)) return m[k];
                }
                return null;
            }
        }

        function updateRecommendationUI(rec) {
            const badge = rec.notRecommended
                ? '<span class="inline-block text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full ml-2">ä¸å»ºè®®æ‘„å…¥</span>'
                : '';

            const nameText = rec.productName ? rec.productName : 'æ­£åœ¨ä¸ºä½ å‡†å¤‡å¥½é€‰æ‹©â€¦';
            const imgHtml = rec.productImage 
                ? `<img src="${rec.productImage}" alt="äº§å“å›¾" class="w-full h-40 object-cover rounded-lg mb-3">`
                : '<div class="w-full h-40 bg-cream rounded-lg mb-3 flex items-center justify-center text-gray-400">æš‚æ— å›¾ç‰‡</div>';

            recommendationResult.innerHTML = `
                <div class="text-left">
                    <p class="font-semibold text-coffee-dark mb-2">${rec.label}${badge}</p>
                    <a href="${rec.url}" target="_blank" rel="noopener" class="block">
                        ${imgHtml}
                        <p class="text-sm text-gray-700 truncate">${nameText}</p>
                        <p class="text-xs text-gray-500 mt-1">å»ºè®®æ‘„å…¥é‡ï¼š${rec.mg} mg</p>
                    </a>
                </div>
            `;
        }

        if (getRecommendationButton) {
            getRecommendationButton.addEventListener('click', getRecommendation);
        }
        
        // è®¡ç®—æ‰€æœ‰å’–å•¡å› é™ä½è‡³ä¸å½±å“ç¡çœ çš„æµ“åº¦çš„æ—¶é—´ï¼ˆä¿®å¤çš„æ ¸å¿ƒé€»è¾‘ï¼‰
        function calculateCompleteClearanceTime() {
            // æŒ‰æ—¶é—´é¡ºåºå¤„ç†å’–å•¡
            const sortedCoffees = [...coffees].sort((a, b) => a.time - b.time);
            const now = new Date();
            
            // æ‰¾åˆ°æœ€åä¸€æ¯å’–å•¡çš„æ—¶é—´
            const lastCoffeeTime = sortedCoffees.length > 0 
                ? new Date(sortedCoffees[sortedCoffees.length - 1].time) 
                : now;
            
            // ä»æœ€åä¸€æ¯å’–å•¡æ—¶é—´å¼€å§‹è®¡ç®—
            let currentTime = new Date(lastCoffeeTime);
            let totalCaffeine;
            
            // å¾ªç¯è®¡ç®—ç›´åˆ°å’–å•¡å› æ°´å¹³ä½äºé˜ˆå€¼
            do {
                totalCaffeine = 0;
                
                // è®¡ç®—å½“å‰æ—¶é—´ä½“å†…çš„å’–å•¡å› æ€»é‡
                sortedCoffees.forEach(coffee => {
                    const hoursPassed = (currentTime - coffee.time) / (1000 * 60 * 60);
                    if (hoursPassed >= 0) {
                        totalCaffeine += coffee.amount * Math.pow(0.5, hoursPassed / HALF_LIFE_HOURS);
                    }
                });
                
                // å¦‚æœè¿˜æ²¡ä»£è°¢å®Œï¼Œå¢åŠ 15åˆ†é’Ÿç»§ç»­è®¡ç®—
                if (totalCaffeine > CLEAR_THRESHOLD) {
                    currentTime.setMinutes(currentTime.getMinutes() + 15);
                }
            } while (totalCaffeine > CLEAR_THRESHOLD);
            
            return currentTime;
        }
        
        // è®¾ç½®çŠ¶æ€æ¶ˆæ¯
        function setStatusMessage(clearTime) {
            const now = new Date();
            const hoursDiff = (clearTime - now) / (1000 * 60 * 60);
            
            let message, emoji;
            
            if (hoursDiff < 1) {
                emoji = 'ğŸ˜´';
                message = 'å¾ˆå¿«å°±èƒ½å®‰å¿ƒç¡è§‰å•¦~';
            } else if (hoursDiff < 4) {
                emoji = 'ğŸ˜Œ';
                message = 'å‡ ä¸ªå°æ—¶åå°±èƒ½ä»£è°¢å®Œå•¦';
            } else if (hoursDiff < 8) {
                emoji = 'ğŸ˜';
                message = 'è¿˜éœ€è¦ä¸€æ®µæ—¶é—´æ‰èƒ½é™ä½è‡³ä¸å½±å“ç¡çœ çš„æµ“åº¦å“¦';
            } else if (hoursDiff < 12) {
                emoji = 'ğŸ˜®';
                message = 'å’–å•¡å› ä¼šåœ¨ä½“å†…åœç•™è¾ƒé•¿æ—¶é—´å‘¢';
            } else {
                emoji = 'ğŸ˜±';
                message = 'ä»Šæ™šå¯èƒ½è¦å¤±çœ äº†...';
            }
            
            statusMessageElement.innerHTML = `${emoji} ${message}`;
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(date) {
            const options = { 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false
            };
            return date.toLocaleString('zh-CN', options);
        }
        
        // æ ¹æ®å’–å•¡é‡è¿”å›ç›¸åº”çš„emoji
        function getCoffeeEmoji(amount) {
            if (amount < 50) return 'â˜•';
            if (amount < 100) return 'â˜•â˜•';
            if (amount < 150) return 'â˜•â˜•â˜•';
            return 'â˜•â˜•â˜•â˜•';
        }
        
        // åˆå§‹åŒ–
        setDefaultTime();
        setDefaultRestTime();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>风险自我评估系统</title>
    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Inter 字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* 自定义样式，确保 Inter 字体应用 */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* 确保所有元素都有圆角 */
        * {
            border-radius: 0.5rem; /* Equivalent to rounded-lg in Tailwind */
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 flex">
    <noscript>您需要启用JavaScript才能运行此应用。</noscript>
    <div id="root" class="flex-1 flex flex-col"></div>

    <!-- 引入 React 和 ReactDOM CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- 引入 Babel 用于 JSX 转换 -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        // 模拟数据
        const mockTemplates = [
            {
                id: 'template-2024',
                year: 2024,
                departments: ['战略部', '市场部', '运营部'],
                categories: [
                    {
                        id: 'cat-gov-2024',
                        name: '治理架构',
                        weight: 0.25,
                        subItems: [
                            { id: 'sub-gov1', name: '董监高履职情况评估', description: '评估董监高在风险管理中的职责履行情况。', score: null, explanation: '', itemComments: [] },
                            { id: 'sub-gov2', name: '组织结构与职责明确性', description: '评估风险管理组织结构是否清晰，职责是否明确。', score: null, explanation: '', itemComments: [] },
                        ],
                    },
                    {
                        id: 'cat-strat-2024',
                        name: '风险管理策略',
                        weight: 0.2,
                        subItems: [
                            { id: 'sub-strat1', name: '风险偏好及策略实施情况', description: '评估公司风险偏好设定及风险管理策略的执行效果。', score: null, explanation: '', itemComments: [] },
                            { id: 'sub-strat2', name: '重大风险识别与评估', description: '评估公司识别和评估重大风险的能力。', score: null, explanation: '', itemComments: [] },
                        ],
                    },
                    {
                        id: 'cat-policy-2024',
                        name: '风险管理政策和程序',
                        weight: 0.2,
                        subItems: [
                            { id: 'sub-policy1', name: '政策和程序制定情况', description: '评估风险管理政策和程序是否健全且有效。', score: null, explanation: '', itemComments: [] },
                            { id: 'sub-policy2', name: '政策和程序执行情况', description: '评估员工对风险管理政策和程序的遵守情况。', score: null, explanation: '', itemComments: [] },
                        ],
                    },
                ],
            },
            {
                id: 'template-2023',
                year: 2023,
                departments: ['战略部', '市场部', '运营部'],
                categories: [
                    {
                        id: 'cat-gov-2023',
                        name: '治理架构',
                        weight: 0.25,
                        subItems: [
                            { id: 'sub-gov1-23', name: '董监高履职情况评估', description: '评估董监高在风险管理中的职责履行情况。', score: 4, explanation: '2023年治理架构运行良好，职责明确。', itemComments: [] },
                        ],
                    },
                    {
                        id: 'cat-strat-2023',
                        name: '风险管理策略',
                        weight: 0.2,
                        subItems: [
                            { id: 'sub-strat1-23', name: '风险偏好及策略实施情况', description: '风险偏好设定合理，策略执行有效。', score: 3, explanation: '2023年风险策略实施情况一般。', itemComments: [] },
                        ],
                    },
                ],
            },
        ];

        const mockAssessments = [
            // 部门评估人 - 待填写
            {
                id: 'assess-1',
                year: 2025,
                department: '战略部',
                riskType: '战略风险',
                status: '待填写', // 待填写, 已提交, 已复核, 待修改
                templateId: 'template-2024',
                content: JSON.parse(JSON.stringify(mockTemplates.find(t => t.id === 'template-2024').categories)), // Deep copy
                reviewerComments: [],
            },
            // 部门评估人 - 已提交
            {
                id: 'assess-2',
                year: 2025,
                department: '市场部',
                riskType: '市场风险',
                status: '已提交',
                templateId: 'template-2024',
                content: [
                    {
                        id: 'cat-gov-2024', name: '治理架构', weight: 0.25,
                        subItems: [
                            { id: 'sub-gov1', name: '董监高履职情况评估', description: '评估董监高在风险管理中的职责履行情况。', score: 4, explanation: '市场部董监高履职情况较好。', itemComments: [] },
                            { id: 'sub-gov2', name: '组织结构与职责明确性', description: '评估风险管理组织结构是否清晰，职责是否明确。', score: 3, explanation: '市场部风险管理组织结构基本明确。', itemComments: [] },
                        ],
                    },
                    {
                        id: 'cat-strat-2024', name: '风险管理策略', weight: 0.2,
                        subItems: [
                            { id: 'sub-strat1', name: '风险偏好及策略实施情况', description: '评估公司风险偏好设定及风险管理策略的执行效果。', score: 3, explanation: '市场部在风险偏好方面仍有提升空间。', itemComments: [] },
                            { id: 'sub-strat2', name: '重大风险识别与评估', description: '评估公司识别和评估重大风险的能力。', score: 4, explanation: '市场部能有效识别重大风险。', itemComments: [] },
                        ],
                    },
                ],
                reviewerComments: [],
            },
            // 部门评估人 - 待修改
            {
                id: 'assess-3',
                year: 2025,
                department: '运营部',
                riskType: '操作风险',
                status: '待修改',
                templateId: 'template-2024',
                content: [
                    {
                        id: 'cat-gov-2024', name: '治理架构', weight: 0.25,
                        subItems: [
                            { id: 'sub-gov1', name: '董监高履职情况评估', description: '评估董监高在风险管理中的职责履行情况。', score: 2, explanation: '运营部需加强董监高风险责任落实。', itemComments: [{ date: '2025-06-16', comment: '董监高职责落实的具体改进措施是什么？请补充。' }] },
                            { id: 'sub-gov2', name: '组织结构与职责明确性', description: '评估风险管理组织结构是否清晰，职责是否明确。', score: 2, explanation: '运营部风险管理职责划分需进一步细化。', itemComments: [] },
                        ],
                    },
                    {
                        id: 'cat-strat-2024', name: '风险管理策略', weight: 0.2,
                        subItems: [
                            { id: 'sub-strat1', name: '风险偏好及策略实施情况', description: '评估公司风险偏好设定及风险管理策略的执行效果。', score: 2, explanation: '运营部风险策略执行存在偏差。', itemComments: [{ date: '2025-06-16', comment: '请提供风险策略执行偏差的详细说明和数据。' }] },
                            { id: 'sub-strat2', name: '重大风险识别与评估', description: '评估公司识别和评估重大风险的能力。', score: 3, explanation: '运营部对部分新兴风险识别不足。', itemComments: [] },
                        ],
                    },
                ],
                reviewerComments: [{ date: '2025-06-16', comment: '整体评估偏保守，部分打分需要提供更充分的依据。' }], // General comment remains
            },
            // RM - 已复核 (历史数据)
            {
                id: 'assess-4',
                year: 2024,
                department: '战略部',
                riskType: '战略风险',
                status: '已复核',
                templateId: 'template-2024', // Uses the same structure for simplicity
                content: [
                    {
                        id: 'cat-gov-2024', name: '治理架构', weight: 0.25,
                        subItems: [
                            { id: 'sub-gov1', name: '董监高履职情况评估', description: '评估董监高在风险管理中的职责履行情况。', score: 5, explanation: '2024年战略部治理架构非常完善。', itemComments: [] },
                            { id: 'sub-gov2', name: '组织结构与职责明确性', description: '评估风险管理组织结构是否清晰，职责是否明确。', score: 5, explanation: '组织结构明确，职责清晰。', itemComments: [] },
                        ],
                    },
                    {
                        id: 'cat-strat-2024', name: '风险管理策略', weight: 0.2,
                        subItems: [
                            { id: 'sub-strat1', name: '风险偏好及策略实施情况', description: '评估公司风险偏好设定及风险管理策略的执行效果。', score: 4, explanation: '风险偏好设定有效，策略实施到位。', itemComments: [] },
                            { id: 'sub-strat2', name: '重大风险识别与评估', description: '评估公司识别和评估重大风险的能力。', score: 4, explanation: '能有效识别并评估重大风险。', itemComments: [] },
                        ],
                    },
                ],
                reviewerComments: [],
            },
        ];

        const riskTypes = ['战略风险', '市场风险', '操作风险', '信用风险', '合规风险', '反洗钱风险'];
        const departments = ['战略部', '市场部', '运营部', '财务部', '人力资源部'];

        // 辅助函数：计算总分和类别分
        const calculateScores = (content) => {
            let totalWeightedScore = 0;
            let categoryScores = {};

            content.forEach(category => {
                let categorySum = 0;
                let subItemCount = 0;
                category.subItems.forEach(item => {
                    if (item.score !== null) {
                        categorySum += item.score;
                        subItemCount++;
                    }
                });
                const avgCategoryScore = subItemCount > 0 ? (categorySum / subItemCount) : 0;
                categoryScores[category.name] = avgCategoryScore;
                totalWeightedScore += avgCategoryScore * category.weight;
            });
            return { totalWeightedScore: parseFloat(totalWeightedScore.toFixed(2)), categoryScores };
        };

        // 模拟通知
        const NotificationBar = ({ notifications }) => {
            if (notifications.length === 0) return null;
            return (
                <div className="absolute top-4 right-4 z-50 bg-blue-100 text-blue-800 p-3 rounded-lg shadow-lg">
                    <h3 className="font-bold text-lg mb-2">待办事项</h3>
                    <ul>
                        {notifications.map((notif, index) => (
                            <li key={index} className="mb-1">
                                <a href="#" className="underline hover:text-blue-600">
                                    {notif.message}
                                </a>
                            </li>
                        ))}
                    </ul>
                </div>
            );
        };

        // 1. 登录组件
        const Login = ({ onLogin }) => {
            const [selectedRole, setSelectedRole] = React.useState(null);
            const [selectedDepartment, setSelectedDepartment] = React.useState('');

            const handleLogin = () => {
                if (selectedRole === 'RM') {
                    onLogin({ role: 'RM', name: '风险管理部用户' });
                } else if (selectedRole === 'Department' && selectedDepartment) {
                    onLogin({ role: 'Department', name: `${selectedDepartment}评估人`, department: selectedDepartment });
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
                        <h2 className="text-3xl font-extrabold text-gray-900 mb-8 text-center">风险自我评估系统</h2>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">选择您的角色:</label>
                                <div className="flex space-x-4">
                                    <button
                                        onClick={() => setSelectedRole('RM')}
                                        className={`flex-1 py-3 px-4 rounded-xl text-lg font-semibold transition-all duration-300
                                            ${selectedRole === 'RM' ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-blue-100'}`}
                                    >
                                        风险管理部用户
                                    </button>
                                    <button
                                        onClick={() => setSelectedRole('Department')}
                                        className={`flex-1 py-3 px-4 rounded-xl text-lg font-semibold transition-all duration-300
                                            ${selectedRole === 'Department' ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-blue-100'}`}
                                    >
                                        部门评估人
                                    </button>
                                </div>
                            </div>

                            {selectedRole === 'Department' && (
                                <div>
                                    <label htmlFor="department-select" className="block text-sm font-medium text-gray-700 mb-2 mt-4">选择您的部门:</label>
                                    <select
                                        id="department-select"
                                        className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-xl shadow-sm"
                                        value={selectedDepartment}
                                        onChange={(e) => setSelectedDepartment(e.target.value)}
                                    >
                                        <option value="">请选择部门</option>
                                        {departments.map(dep => (
                                            <option key={dep} value={dep}>{dep}</option>
                                        ))}
                                    </select>
                                </div>
                            )}

                            <button
                                onClick={handleLogin}
                                disabled={!selectedRole || (selectedRole === 'Department' && !selectedDepartment)}
                                className={`w-full py-3 px-4 rounded-xl text-lg font-bold transition-all duration-300
                                    ${(!selectedRole || (selectedRole === 'Department' && !selectedDepartment))
                                        ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                        : 'bg-green-600 text-white hover:bg-green-700 shadow-md'}`}
                            >
                                登录
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // 4. 评估模板管理与分发 (RM 用户功能)
        const RMTemplateManagement = ({ user, templates, setTemplates, setAssessments, allAssessments, setNotifications, setCurrentView }) => {
            const [newTemplateYear, setNewTemplateYear] = React.useState(new Date().getFullYear() + 1);
            const [selectedTemplateForDistribution, setSelectedTemplateForDistribution] = React.useState(null);
            const [departmentsToDistribute, setDepartmentsToDistribute] = React.useState([]);
            const [isDistributing, setIsDistributing] = React.useState(false);

            const handleCreateNewTemplate = () => {
                // 复制上年模板功能
                const lastYearTemplate = templates.find(t => t.year === (newTemplateYear - 1));
                let newTemplateContent;
                if (lastYearTemplate) {
                    // Deep copy categories to avoid modifying the original template
                    newTemplateContent = JSON.parse(JSON.stringify(lastYearTemplate.categories));
                    // Ensure new subItems have itemComments property
                    newTemplateContent.forEach(cat => {
                        cat.subItems.forEach(item => {
                            if (!item.hasOwnProperty('itemComments')) {
                                item.itemComments = [];
                            }
                        });
                    });
                    alert(`已复制 ${newTemplateYear - 1} 年模板结构，请编辑！`);
                } else {
                    // 默认结构
                    newTemplateContent = [
                        {
                            id: `cat-new-gov-${newTemplateYear}`, name: '治理架构', weight: 0.25,
                            subItems: [
                                { id: `sub-new-gov1-${newTemplateYear}`, name: '董监高履职情况评估', description: '评估董监高在风险管理中的职责履行情况。', score: null, explanation: '', itemComments: [] },
                            ],
                        },
                        {
                            id: `cat-new-strat-${newTemplateYear}`, name: '风险管理策略', weight: 0.2,
                            subItems: [
                                { id: `sub-new-strat1-${newTemplateYear}`, name: '风险偏好及策略实施情况', description: '评估公司风险偏好设定及风险管理策略的执行效果。', score: null, explanation: '', itemComments: [] },
                            ],
                        },
                    ];
                    alert('已创建空白模板，请完善内容！');
                }

                const newTemplate = {
                    id: `template-${newTemplateYear}`,
                    year: newTemplateYear,
                    departments: [], // Departments will be added upon distribution
                    categories: newTemplateContent,
                };
                setTemplates([...templates, newTemplate]);
                setSelectedTemplateForDistribution(newTemplate.id); // Automatically select for distribution
            };

            const handleDistributeTemplate = () => {
                if (!selectedTemplateForDistribution || departmentsToDistribute.length === 0) {
                    alert('请选择模板并选择要分发的部门！');
                    return;
                }

                setIsDistributing(true);
                const templateToDistribute = templates.find(t => t.id === selectedTemplateForDistribution);
                if (!templateToDistribute) {
                    setIsDistributing(false);
                    return;
                }

                const newAssessments = departmentsToDistribute.map(dep => {
                    // Check if an assessment already exists for this department and year
                    const existingAssessment = allAssessments.find(a => a.year === templateToDistribute.year && a.department === dep);
                    if (existingAssessment) {
                        console.warn(`Assessment already exists for ${dep} in ${templateToDistribute.year}. Skipping.`);
                        return null; // Skip if already exists
                    }

                    // Determine risk type for the department (simplified, could be more complex mapping)
                    let riskType = '其他风险';
                    if (dep === '战略部') riskType = '战略风险';
                    if (dep === '市场部') riskType = '市场风险';
                    if (dep === '运营部') riskType = '操作风险';
                    if (dep === '财务部') riskType = '信用风险'; // Example
                    if (dep === '人力资源部') riskType = '合规风险'; // Example


                    const contentWithItemComments = JSON.parse(JSON.stringify(templateToDistribute.categories));
                    contentWithItemComments.forEach(cat => {
                        cat.subItems.forEach(item => {
                            item.itemComments = []; // Ensure new assessments have empty item comments
                        });
                    });

                    return {
                        id: `assess-${Date.now()}-${dep}`,
                        year: templateToDistribute.year,
                        department: dep,
                        riskType: riskType,
                        status: '待填写',
                        templateId: templateToDistribute.id,
                        content: contentWithItemComments, // Use the deep copied content with itemComments
                        reviewerComments: [],
                    };
                }).filter(Boolean); // Remove nulls from skipped assessments

                setAssessments(prevAssessments => [...prevAssessments, ...newAssessments]);

                // Update notifications for department assessors
                newAssessments.forEach(assessment => {
                    setNotifications(prev => [...prev, {
                        type: 'new-task',
                        message: `${assessment.department}，您有新的 ${assessment.year} 年 ${assessment.riskType} 评估任务待处理！`,
                        link: `/assessment/${assessment.id}`, // Placeholder link for now
                    }]);
                });

                setTimeout(() => {
                    alert('评估任务已成功分发！');
                    setIsDistributing(false);
                    // Optionally navigate to a different view or clear selections
                    setDepartmentsToDistribute([]);
                    setSelectedTemplateForDistribution(null);
                }, 1000); // Simulate API call
            };

            const availableTemplates = templates.filter(t => t.year <= new Date().getFullYear() + 1);

            return (
                <div className="p-6 bg-white rounded-2xl shadow-xl">
                    <h2 className="text-3xl font-extrabold text-gray-900 mb-6">评估模板管理与分发</h2>

                    <div className="mb-8 p-6 border border-blue-200 rounded-xl bg-blue-50">
                        <h3 className="text-2xl font-semibold text-blue-800 mb-4">新建与复制模板</h3>
                        <div className="flex items-center space-x-4 mb-4">
                            <label htmlFor="new-template-year" className="text-lg text-gray-700">新模板年份:</label>
                            <input
                                type="number"
                                id="new-template-year"
                                value={newTemplateYear}
                                onChange={(e) => setNewTemplateYear(parseInt(e.target.value))}
                                className="flex-1 p-2 border border-gray-300 rounded-xl shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                min={new Date().getFullYear()}
                            />
                        </div>
                        <button
                            onClick={handleCreateNewTemplate}
                            className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition-all duration-300 transform hover:scale-105"
                        >
                            创建新评估模板 (复制上年模板)
                        </button>
                        <p className="text-sm text-gray-500 mt-2">点击此按钮可创建新年份的空白模板，若上年模板存在，则会自动复制其结构。</p>
                    </div>

                    <div className="mb-8 p-6 border border-green-200 rounded-xl bg-green-50">
                        <h3 className="text-2xl font-semibold text-green-800 mb-4">模板分发</h3>
                        <div className="mb-4">
                            <label htmlFor="select-template-distribute" className="block text-lg font-medium text-gray-700 mb-2">选择要分发的模板:</label>
                            <select
                                id="select-template-distribute"
                                className="w-full p-2 border border-gray-300 rounded-xl shadow-sm focus:ring-green-500 focus:border-green-500"
                                value={selectedTemplateForDistribution || ''}
                                onChange={(e) => setSelectedTemplateForDistribution(e.target.value)}
                            >
                                <option value="">请选择模板</option>
                                {availableTemplates.map(template => (
                                    <option key={template.id} value={template.id}>
                                        {template.year} 年评估模板
                                    </option>
                                ))}
                            </select>
                        </div>

                        <div className="mb-4">
                            <label className="block text-lg font-medium text-gray-700 mb-2">选择分发部门:</label>
                            <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                {departments.map(dep => (
                                    <div key={dep} className="flex items-center">
                                        <input
                                            type="checkbox"
                                            id={`dep-${dep}`}
                                            value={dep}
                                            checked={departmentsToDistribute.includes(dep)}
                                            onChange={(e) => {
                                                if (e.target.checked) {
                                                    setDepartmentsToDistribute([...departmentsToDistribute, dep]);
                                                } else {
                                                    setDepartmentsToDistribute(departmentsToDistribute.filter(d => d !== dep));
                                                }
                                            }}
                                            className="h-5 w-5 text-green-600 rounded focus:ring-green-500"
                                        />
                                        <label htmlFor={`dep-${dep}`} className="ml-2 text-md text-gray-700">{dep}</label>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <button
                            onClick={handleDistributeTemplate}
                            disabled={!selectedTemplateForDistribution || departmentsToDistribute.length === 0 || isDistributing}
                            className={`w-full py-3 px-6 rounded-xl font-bold shadow-lg transition-all duration-300 transform hover:scale-105
                                ${(!selectedTemplateForDistribution || departmentsToDistribute.length === 0 || isDistributing)
                                    ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                    : 'bg-green-600 text-white hover:bg-green-700'}`}
                        >
                            {isDistributing ? '正在分发...' : '向各部门分发评估任务'}
                        </button>
                        <p className="text-sm text-gray-500 mt-2">将选定模板分发给指定部门，系统将向评估人发送通知。</p>
                    </div>
                </div>
            );
        };

        // 5. 风险自我评估填写 (部门评估人功能)
        const DepartmentAssessment = ({ user, assessments, setAssessments, setCurrentView }) => {
            const currentYear = new Date().getFullYear();
            const departmentAssessments = assessments.filter(
                a => a.department === user.department && a.year === currentYear
            );

            const [activeAssessmentId, setActiveAssessmentId] = React.useState(
                departmentAssessments.length > 0 ? departmentAssessments[0].id : null
            );
            const [currentAssessment, setCurrentAssessment] = React.useState(null);
            const [isSubmitting, setIsSubmitting] = React.useState(false);
            const [isModalOpen, setIsModalOpen] = React.useState(false);
            const [modalMessage, setModalMessage] = React.useState('');

            React.useEffect(() => {
                if (activeAssessmentId) {
                    const found = assessments.find(a => a.id === activeAssessmentId);
                    setCurrentAssessment(found ? JSON.parse(JSON.stringify(found)) : null); // Deep copy for editing
                } else {
                    setCurrentAssessment(null);
                }
            }, [activeAssessmentId, assessments]);

            const handleScoreChange = (categoryId, subItemId, score) => {
                if (currentAssessment) {
                    const updatedContent = currentAssessment.content.map(cat => {
                        if (cat.id === categoryId) {
                            return {
                                ...cat,
                                subItems: cat.subItems.map(item =>
                                    item.id === subItemId ? { ...item, score: parseInt(score) } : item
                                ),
                            };
                        }
                        return cat;
                    });
                    setCurrentAssessment({ ...currentAssessment, content: updatedContent });
                }
            };

            const handleExplanationChange = (categoryId, subItemId, explanation) => {
                if (currentAssessment) {
                    const updatedContent = currentAssessment.content.map(cat => {
                        if (cat.id === categoryId) {
                            return {
                                ...cat,
                                subItems: cat.subItems.map(item =>
                                    item.id === subItemId ? { ...item, explanation: explanation } : item
                                ),
                            };
                        }
                        return cat;
                    });
                    setCurrentAssessment({ ...currentAssessment, content: updatedContent });
                }
            };

            const handleSave = () => {
                if (!currentAssessment) return;
                setIsSubmitting(true);
                setTimeout(() => {
                    setAssessments(prev => prev.map(a =>
                        a.id === currentAssessment.id ? { ...currentAssessment } : a
                    ));
                    setModalMessage('评估内容已保存！');
                    setIsModalOpen(true);
                    setIsSubmitting(false);
                }, 500);
            };

            const handleSubmit = () => {
                if (!currentAssessment) return;

                // Check if all scores are filled
                const allScoresFilled = currentAssessment.content.every(category =>
                    category.subItems.every(item => item.score !== null)
                );

                if (!allScoresFilled) {
                    setModalMessage('请填写所有评估项的得分后再提交！');
                    setIsModalOpen(true);
                    return;
                }

                setIsSubmitting(true);
                setTimeout(() => {
                    setAssessments(prev => prev.map(a =>
                        a.id === currentAssessment.id ? { ...currentAssessment, status: '已提交' } : a
                    ));
                    setModalMessage('评估任务已提交至风险管理部复核！');
                    setIsModalOpen(true);
                    setIsSubmitting(false);
                }, 1000);
            };

            const handleDownloadForm = () => {
                if (!currentAssessment) {
                    setModalMessage('没有评估内容可下载。');
                    setIsModalOpen(true);
                    return;
                }

                let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // BOM for UTF-8
                csvContent += "评估年份,风险类型,部门,评估大类,子评估项,评估说明,得分\n";

                currentAssessment.content.forEach(category => {
                    category.subItems.forEach(item => {
                        const row = [
                            currentAssessment.year,
                            currentAssessment.riskType,
                            currentAssessment.department,
                            category.name,
                            item.name,
                            `"${item.explanation.replace(/"/g, '""')}"`, // Handle commas and quotes in explanation
                            item.score !== null ? item.score : '未填写',
                        ].join(',');
                        csvContent += row + "\n";
                    });
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `${currentAssessment.year}-${currentAssessment.department}-${currentAssessment.riskType}-评估表单.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                setModalMessage('评估表单已下载为CSV格式。');
                setIsModalOpen(true);
            };


            const { totalWeightedScore, categoryScores } = currentAssessment ? calculateScores(currentAssessment.content) : { totalWeightedScore: 0, categoryScores: {} };

            if (departmentAssessments.length === 0) {
                return (
                    <div className="p-6 bg-white rounded-2xl shadow-xl text-center">
                        <h2 className="text-3xl font-extrabold text-gray-900 mb-4">风险自我评估填写</h2>
                        <p className="text-lg text-gray-600">您当前没有待处理的 {currentYear} 年评估任务。</p>
                        <p className="text-md text-gray-500 mt-2">请等待风险管理部发布新的评估任务。</p>
                    </div>
                );
            }

            return (
                <div className="p-6 bg-white rounded-2xl shadow-xl">
                    <h2 className="text-3xl font-extrabold text-gray-900 mb-6">风险自我评估填写</h2>

                    <div className="mb-4 flex flex-wrap items-center gap-4">
                        <label htmlFor="assessment-select" className="text-lg font-medium text-gray-700">选择评估任务:</label>
                        <select
                            id="assessment-select"
                            className="flex-grow p-2 border border-gray-300 rounded-xl shadow-sm focus:ring-blue-500 focus:border-blue-500"
                            value={activeAssessmentId || ''}
                            onChange={(e) => setActiveAssessmentId(e.target.value)}
                        >
                            {departmentAssessments.map(assess => (
                                <option key={assess.id} value={assess.id}>
                                    {assess.year}年 - {assess.riskType} ({assess.status})
                                </option>
                            ))}
                        </select>
                    </div>

                    {currentAssessment && (
                        <div className="border border-blue-200 rounded-xl p-6 bg-blue-50 mb-6">
                            <h3 className="text-2xl font-semibold text-blue-800 mb-3">
                                {currentAssessment.year} 年 {currentAssessment.department} {currentAssessment.riskType} 风险自我评估
                            </h3>
                            <p className="text-lg text-gray-700 mb-2">当前状态: <span className={`font-bold ${currentAssessment.status === '待填写' ? 'text-orange-500' : currentAssessment.status === '待修改' ? 'text-red-500' : 'text-green-600'}`}>{currentAssessment.status}</span></p>
                            {currentAssessment.reviewerComments.length > 0 && (
                                <div className="bg-red-100 border border-red-300 text-red-800 p-3 rounded-lg mb-4">
                                    <h4 className="font-bold">复核意见 (整体):</h4>
                                    {currentAssessment.reviewerComments.map((comment, idx) => (
                                        <p key={idx} className="text-sm mt-1">{comment.date}: {comment.comment}</p>
                                    ))}
                                </div>
                            )}

                            <div className="flex justify-between items-center mb-4">
                                <button
                                    onClick={handleDownloadForm}
                                    className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-5 rounded-xl shadow-md transition-all duration-300 transform hover:scale-105"
                                >
                                    下载评估表单
                                </button>
                                <div className="text-lg font-bold text-gray-800">
                                    最终自评估分数: <span className="text-blue-700">{totalWeightedScore}</span>
                                </div>
                            </div>

                            {currentAssessment.content.map(category => (
                                <div key={category.id} className="mb-8 p-5 border border-gray-200 rounded-xl bg-white shadow-sm">
                                    <h4 className="text-xl font-bold text-gray-800 mb-4">{category.name} ({category.weight * 100}% 比重) - 平均分: {categoryScores[category.name] ? categoryScores[category.name].toFixed(2) : 'N/A'}</h4>
                                    {category.subItems.map(item => (
                                        <div key={item.id} className="mb-5 p-4 border border-gray-100 rounded-lg bg-gray-50">
                                            <p className="text-lg font-semibold text-gray-700 mb-2">{item.name}</p>
                                            <p className="text-md text-gray-600 mb-3">{item.description}</p>
                                            <div className="flex flex-col sm:flex-row items-start sm:items-center mb-3">
                                                <label htmlFor={`score-${item.id}`} className="w-full sm:w-24 text-md font-medium text-gray-700 mb-2 sm:mb-0">打分:</label>
                                                <select
                                                    id={`score-${item.id}`}
                                                    className="flex-grow p-2 border border-gray-300 rounded-xl shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                                    value={item.score !== null ? item.score : ''}
                                                    onChange={(e) => handleScoreChange(category.id, item.id, e.target.value)}
                                                    disabled={currentAssessment.status === '已提交' || currentAssessment.status === '已复核'}
                                                >
                                                    <option value="">请选择</option>
                                                    <option value="5">很强 (5分)</option>
                                                    <option value="4">较强 (4分)</option>
                                                    <option value="3">中等 (3分)</option>
                                                    <option value="2">较弱 (2分)</option>
                                                    <option value="1">很弱 (1分)</option>
                                                </select>
                                            </div>
                                            <div className="flex flex-col sm:flex-row items-start sm:items-center">
                                                <label htmlFor={`explanation-${item.id}`} className="w-full sm:w-24 text-md font-medium text-gray-700 mb-2 sm:mb-0">评估说明:</label>
                                                <textarea
                                                    id={`explanation-${item.id}`}
                                                    className="flex-grow p-2 border border-gray-300 rounded-xl shadow-sm focus:ring-blue-500 focus:border-blue-500 min-h-[60px]"
                                                    value={item.explanation}
                                                    onChange={(e) => handleExplanationChange(category.id, item.id, e.target.value)}
                                                    placeholder="请提供文字性评估说明"
                                                    rows="3"
                                                    disabled={currentAssessment.status === '已提交' || currentAssessment.status === '已复核'}
                                                ></textarea>
                                            </div>
                                            {/* Display RM's per-item comments here */}
                                            {currentAssessment.status === '待修改' && item.itemComments && item.itemComments.length > 0 && (
                                                <div className="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                                    <p className="text-sm font-semibold text-yellow-800 mb-1">风险管理部意见 (针对此项):</p>
                                                    {item.itemComments.map((comment, idx) => (
                                                        <p key={idx} className="text-sm text-yellow-700">{comment.date}: {comment.comment}</p>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            ))}

                            <div className="flex justify-end space-x-4 mt-6">
                                <button
                                    onClick={handleSave}
                                    disabled={isSubmitting || currentAssessment.status === '已提交' || currentAssessment.status === '已复核'}
                                    className={`py-3 px-6 rounded-xl font-bold shadow-lg transition-all duration-300 transform hover:scale-105
                                        ${(isSubmitting || currentAssessment.status === '已提交' || currentAssessment.status === '已复核')
                                            ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                            : 'bg-blue-600 text-white hover:bg-blue-700'}`}
                                >
                                    {isSubmitting ? '正在保存...' : '保存'}
                                </button>
                                <button
                                    onClick={handleSubmit}
                                    disabled={isSubmitting || currentAssessment.status === '已提交' || currentAssessment.status === '已复核'}
                                    className={`py-3 px-6 rounded-xl font-bold shadow-lg transition-all duration-300 transform hover:scale-105
                                        ${(isSubmitting || currentAssessment.status === '已提交' || currentAssessment.status === '已复核')
                                            ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                            : 'bg-green-600 text-white hover:bg-green-700'}`}
                                >
                                    {isSubmitting ? '正在提交...' : '提交'}
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Custom Modal */}
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center">
                                <p className="text-lg font-semibold text-gray-800 mb-6">{modalMessage}</p>
                                <button
                                    onClick={() => setIsModalOpen(false)}
                                    className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-xl shadow-md"
                                >
                                    确定
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 6. 审核流程 (RM 用户功能)
        const RMReview = ({ user, assessments, setAssessments, setNotifications, setCurrentView }) => {
            const [selectedAssessmentId, setSelectedAssessmentId] = React.useState(null);
            const [currentReviewAssessment, setCurrentReviewAssessment] = React.useState(null);
            const [generalCommentText, setGeneralCommentText] = React.useState(''); // For general comments
            const [isProcessing, setIsProcessing] = React.useState(false);
            const [isModalOpen, setIsModalOpen] = React.useState(false);
            const [modalMessage, setModalMessage] = React.useState('');

            const assessmentsToReview = assessments.filter(a => a.status === '已提交' || a.status === '待修改');

            React.useEffect(() => {
                if (selectedAssessmentId) {
                    const found = assessments.find(a => a.id === selectedAssessmentId);
                    if (found) {
                        const copiedAssessment = JSON.parse(JSON.stringify(found));
                        // Initialize itemComments if not present (for older mock data)
                        copiedAssessment.content.forEach(cat => {
                            cat.subItems.forEach(item => {
                                if (!item.hasOwnProperty('itemComments')) {
                                    item.itemComments = [];
                                }
                            });
                        });
                        setCurrentReviewAssessment(copiedAssessment);
                        setGeneralCommentText(copiedAssessment.reviewerComments.length > 0 ? copiedAssessment.reviewerComments[0].comment : ''); // Assuming first comment is general
                    } else {
                        setCurrentReviewAssessment(null);
                        setGeneralCommentText('');
                    }
                } else {
                    setCurrentReviewAssessment(null);
                    setGeneralCommentText('');
                }
            }, [selectedAssessmentId, assessments]);

            const handleScoreChange = (categoryId, subItemId, score) => {
                if (currentReviewAssessment) {
                    const updatedContent = currentReviewAssessment.content.map(cat => {
                        if (cat.id === categoryId) {
                            return {
                                ...cat,
                                subItems: cat.subItems.map(item =>
                                    item.id === subItemId ? { ...item, score: parseInt(score) } : item
                                ),
                            };
                        }
                        return cat;
                    });
                    setCurrentReviewAssessment({ ...currentReviewAssessment, content: updatedContent });
                }
            };

            const handleExplanationChange = (categoryId, subItemId, explanation) => {
                if (currentReviewAssessment) {
                    const updatedContent = currentReviewAssessment.content.map(cat => {
                        if (cat.id === categoryId) {
                            return {
                                ...cat,
                                subItems: cat.subItems.map(item =>
                                    item.id === subItemId ? { ...item, explanation: explanation } : item
                                ),
                            };
                        }
                        return cat;
                    });
                    setCurrentReviewAssessment({ ...currentReviewAssessment, content: updatedContent });
                }
            };

            // Handler for per-item comments
            const handleItemCommentChange = (categoryId, subItemId, comment) => {
                if (currentReviewAssessment) {
                    const updatedContent = currentReviewAssessment.content.map(cat => {
                        if (cat.id === categoryId) {
                            return {
                                ...cat,
                                subItems: cat.subItems.map(item =>
                                    item.id === subItemId ? { ...item, itemComments: [{ date: new Date().toISOString().split('T')[0], comment: comment }] } : item // Overwrite or add first comment
                                ),
                            };
                        }
                        return cat;
                    });
                    setCurrentReviewAssessment({ ...currentReviewAssessment, content: updatedContent });
                }
            };

            const handleSaveReview = () => {
                if (!currentReviewAssessment) return;
                setIsProcessing(true);
                setTimeout(() => {
                    // Update general comments
                    const updatedReviewerComments = generalCommentText.trim() ? [{ date: new Date().toISOString().split('T')[0], comment: generalCommentText.trim() }] : [];

                    setAssessments(prev => prev.map(a =>
                        a.id === currentReviewAssessment.id ? {
                            ...currentReviewAssessment,
                            reviewerComments: updatedReviewerComments, // Save general comments
                        } : a
                    ));
                    setModalMessage('复核内容已保存！');
                    setIsModalOpen(true);
                    setIsProcessing(false);
                }, 500);
            };

            const handleReject = () => {
                if (!currentReviewAssessment) return;
                setIsProcessing(true);
                setTimeout(() => {
                    // Update general comments
                    const updatedReviewerComments = generalCommentText.trim() ? [{ date: new Date().toISOString().split('T')[0], comment: generalCommentText.trim() }] : [];

                    const updatedAssessment = {
                        ...currentReviewAssessment,
                        status: '待修改',
                        reviewerComments: updatedReviewerComments, // Save general comments
                    };
                    setAssessments(prev => prev.map(a =>
                        a.id === updatedAssessment.id ? updatedAssessment : a
                    ));
                    setNotifications(prev => [...prev, {
                        type: 'task-rejected',
                        message: `${updatedAssessment.department}，您的 ${updatedAssessment.year} 年 ${updatedAssessment.riskType} 评估已被驳回，请查看复核意见并修改！`,
                        link: `/assessment/${updatedAssessment.id}`,
                    }]);
                    setModalMessage('评估任务已驳回修改，已通知部门评估人。');
                    setIsModalOpen(true);
                    setIsProcessing(false);
                    setSelectedAssessmentId(null); // Clear selection after action
                }, 1000);
            };

            const handleCompleteReview = () => {
                if (!currentReviewAssessment) return;
                setIsProcessing(true);
                setTimeout(() => {
                    // Update general comments
                    const updatedReviewerComments = generalCommentText.trim() ? [{ date: new Date().toISOString().split('T')[0], comment: generalCommentText.trim() }] : [];

                    setAssessments(prev => prev.map(a =>
                        a.id === currentReviewAssessment.id ? {
                            ...currentReviewAssessment,
                            status: '已复核',
                            reviewerComments: updatedReviewerComments, // Save general comments
                        } : a
                    ));
                    setModalMessage('评估任务已完成复核！');
                    setIsModalOpen(true);
                    setIsProcessing(false);
                    setSelectedAssessmentId(null); // Clear selection after action
                }, 1000);
            };

            const { totalWeightedScore, categoryScores } = currentReviewAssessment ? calculateScores(currentReviewAssessment.content) : { totalWeightedScore: 0, categoryScores: {} };


            return (
                <div className="p-6 bg-white rounded-2xl shadow-xl">
                    <h2 className="text-3xl font-extrabold text-gray-900 mb-6">风险评估管理</h2> {/* Changed title here */}

                    <div className="mb-4 flex flex-wrap items-center gap-4">
                        <label htmlFor="review-assessment-select" className="text-lg font-medium text-gray-700">选择待复核任务:</label>
                        <select
                            id="review-assessment-select"
                            className="flex-grow p-2 border border-gray-300 rounded-xl shadow-sm focus:ring-blue-500 focus:border-blue-500"
                            value={selectedAssessmentId || ''}
                            onChange={(e) => setSelectedAssessmentId(e.target.value)}
                        >
                            <option value="">请选择评估任务</option>
                            {assessmentsToReview.map(assess => (
                                <option key={assess.id} value={assess.id}>
                                    {assess.year}年 - {assess.department} - {assess.riskType} ({assess.status})
                                </option>
                            ))}
                        </select>
                    </div>

                    {currentReviewAssessment && (
                        <div className="border border-green-200 rounded-xl p-6 bg-green-50 mb-6">
                            <h3 className="text-2xl font-semibold text-green-800 mb-3">
                                复核 {currentReviewAssessment.year} 年 {currentReviewAssessment.department} {currentReviewAssessment.riskType} 风险自我评估
                            </h3>
                            <p className="text-lg text-gray-700 mb-2">当前状态: <span className={`font-bold ${currentReviewAssessment.status === '待修改' ? 'text-red-500' : 'text-orange-500'}`}>{currentReviewAssessment.status}</span></p>

                            <div className="flex justify-between items-center mb-4">
                                <div className="text-lg font-bold text-gray-800">
                                    最终自评估分数: <span className="text-green-700">{totalWeightedScore}</span>
                                </div>
                            </div>

                            {currentReviewAssessment.content.map(category => (
                                <div key={category.id} className="mb-8 p-5 border border-gray-200 rounded-xl bg-white shadow-sm">
                                    <h4 className="text-xl font-bold text-gray-800 mb-4">{category.name} ({category.weight * 100}% 比重) - 平均分: {categoryScores[category.name] ? categoryScores[category.name].toFixed(2) : 'N/A'}</h4>
                                    {category.subItems.map(item => (
                                        <div key={item.id} className="mb-5 p-4 border border-gray-100 rounded-lg bg-gray-50">
                                            <p className="text-lg font-semibold text-gray-700 mb-2">{item.name}</p>
                                            <p className="text-md text-gray-600 mb-3">{item.description}</p>
                                            <div className="flex flex-col sm:flex-row items-start sm:items-center mb-3">
                                                <label htmlFor={`review-score-${item.id}`} className="w-full sm:w-24 text-md font-medium text-gray-700 mb-2 sm:mb-0">打分:</label>
                                                <select
                                                    id={`review-score-${item.id}`}
                                                    className="flex-grow p-2 border border-gray-300 rounded-xl shadow-sm focus:ring-green-500 focus:border-green-500"
                                                    value={item.score !== null ? item.score : ''}
                                                    onChange={(e) => handleScoreChange(category.id, item.id, e.target.value)}
                                                >
                                                    <option value="">请选择</option>
                                                    <option value="5">很强 (5分)</option>
                                                    <option value="4">较强 (4分)</option>
                                                    <option value="3">中等 (3分)</option>
                                                    <option value="2">较弱 (2分)</option>
                                                    <option value="1">很弱 (1分)</option>
                                                </select>
                                            </div>
                                            <div className="flex flex-col sm:flex-row items-start sm:items-center">
                                                <label htmlFor={`review-explanation-${item.id}`} className="w-full sm:w-24 text-md font-medium text-gray-700 mb-2 sm:mb-0">评估说明:</label>
                                                <textarea
                                                    id={`review-explanation-${item.id}`}
                                                    className="flex-grow p-2 border border-gray-300 rounded-xl shadow-sm focus:ring-green-500 focus:border-green-500 min-h-[60px]"
                                                    value={item.explanation}
                                                    onChange={(e) => handleExplanationChange(category.id, item.id, e.target.value)}
                                                    placeholder="请提供文字性评估说明"
                                                    rows="3"
                                                ></textarea>
                                            </div>
                                            {/* RM's per-item comment box */}
                                            <div className="mt-4">
                                                <label htmlFor={`rm-item-comment-${item.id}`} className="block text-sm font-medium text-gray-700 mb-1">风险管理部意见 (针对此项):</label>
                                                <textarea
                                                    id={`rm-item-comment-${item.id}`}
                                                    className="w-full p-2 border border-gray-300 rounded-xl shadow-sm focus:ring-blue-500 focus:border-blue-500 min-h-[60px]"
                                                    value={item.itemComments && item.itemComments.length > 0 ? item.itemComments[0].comment : ''} // Display current comment
                                                    onChange={(e) => handleItemCommentChange(category.id, item.id, e.target.value)}
                                                    placeholder="输入针对此评估小项的意见..."
                                                    rows="2"
                                                ></textarea>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ))}

                            <div className="mt-6 p-4 border border-gray-200 rounded-xl bg-white shadow-sm">
                                <h4 className="text-xl font-bold text-gray-800 mb-4">整体复核意见</h4>
                                {currentReviewAssessment.reviewerComments.length > 0 ? (
                                    <ul className="mb-4 space-y-2">
                                        {currentReviewAssessment.reviewerComments.map((comment, idx) => (
                                            <li key={idx} className="bg-gray-50 p-3 rounded-lg text-gray-700 text-sm">
                                                <span className="font-semibold text-gray-600">{comment.date}:</span> {comment.comment}
                                            </li>
                                        ))}
                                    </ul>
                                ) : (
                                    <p className="text-gray-500 mb-4">暂无整体复核意见。</p>
                                )}
                                <textarea
                                    className="w-full p-2 border border-gray-300 rounded-xl shadow-sm focus:ring-blue-500 focus:border-blue-500 min-h-[80px] mb-3"
                                    placeholder="添加整体评论..."
                                    value={generalCommentText}
                                    onChange={(e) => setGeneralCommentText(e.target.value)}
                                    rows="4"
                                ></textarea>
                                <div className="flex justify-end space-x-3">
                                    <button
                                        onClick={handleSaveReview}
                                        disabled={isProcessing}
                                        className={`flex-1 py-2 px-5 rounded-xl font-bold shadow-md transition-all duration-300 transform hover:scale-105
                                            ${isProcessing ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'}`}
                                    >
                                        {isProcessing ? '正在保存...' : '保存复核'}
                                    </button>
                                </div>
                            </div>

                            <div className="flex justify-end space-x-4 mt-6">
                                <button
                                    onClick={handleReject}
                                    disabled={isProcessing}
                                    className={`py-3 px-6 rounded-xl font-bold shadow-lg transition-all duration-300 transform hover:scale-105
                                        ${isProcessing ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-red-600 text-white hover:bg-red-700'}`}
                                >
                                    {isProcessing ? '正在驳回...' : '驳回修改'}
                                </button>
                                <button
                                    onClick={handleCompleteReview}
                                    disabled={isProcessing}
                                    className={`py-3 px-6 rounded-xl font-bold shadow-lg transition-all duration-300 transform hover:scale-105
                                        ${isProcessing ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-green-600 text-white hover:bg-green-700'}`}
                                >
                                    {isProcessing ? '正在完成...' : '完成复核'}
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Custom Modal */}
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center">
                                <p className="text-lg font-semibold text-gray-800 mb-6">{modalMessage}</p>
                                <button
                                    onClick={() => setIsModalOpen(false)}
                                    className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-xl shadow-md"
                                >
                                    确定
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };


        // 7. 报告查阅功能
        const HistoricalReports = ({ user, assessments }) => {
            const allYears = [...new Set(assessments.map(a => a.year))].sort((a, b) => b - a);
            const allRiskTypes = [...new Set(assessments.map(a => a.riskType))].sort();

            const [selectedYear, setSelectedYear] = React.useState('');
            const [selectedRiskType, setSelectedRiskType] = React.useState('');

            const filteredReports = assessments.filter(a => {
                const matchesYear = selectedYear === '' || a.year === parseInt(selectedYear);
                const matchesRiskType = selectedRiskType === '' || a.riskType === selectedRiskType;

                let canView = false;
                if (user.role === 'RM') {
                    canView = true; // RM can view all
                } else if (user.role === 'Department') {
                    // Department can view their own department's assessments for their assigned risk type
                    canView = a.department === user.department && a.riskType === a.riskType; // Assuming Department user only has one risk type to view
                }
                return matchesYear && matchesRiskType && canView;
            }).sort((a, b) => b.year - a.year || a.riskType.localeCompare(b.riskType));

            return (
                <div className="p-6 bg-white rounded-2xl shadow-xl">
                    <h2 className="text-3xl font-extrabold text-gray-900 mb-6">历史评估报告</h2>

                    <div className="flex flex-wrap gap-4 mb-6 p-4 border border-gray-200 rounded-xl bg-gray-50">
                        <div className="flex-1 min-w-[150px]">
                            <label htmlFor="year-filter" className="block text-sm font-medium text-gray-700 mb-1">年份筛选:</label>
                            <select
                                id="year-filter"
                                className="w-full p-2 border border-gray-300 rounded-xl shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                value={selectedYear}
                                onChange={(e) => setSelectedYear(e.target.value)}
                            >
                                <option value="">所有年份</option>
                                {allYears.map(year => (
                                    <option key={year} value={year}>{year}</option>
                                ))}
                            </select>
                        </div>
                        <div className="flex-1 min-w-[150px]">
                            <label htmlFor="risk-type-filter" className="block text-sm font-medium text-gray-700 mb-1">风险类型筛选:</label>
                            <select
                                id="risk-type-filter"
                                className="w-full p-2 border border-gray-300 rounded-xl shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                value={selectedRiskType}
                                onChange={(e) => setSelectedRiskType(e.target.value)}
                            >
                                <option value="">所有风险类型</option>
                                {allRiskTypes.map(type => (
                                    <option key={type} value={type}>{type}</option>
                                ))}
                            </select>
                        </div>
                    </div>

                    {filteredReports.length === 0 ? (
                        <p className="text-center text-lg text-gray-600 mt-8">没有找到符合条件的报告。</p>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="min-w-full bg-white rounded-xl shadow-md border border-gray-200">
                                <thead className="bg-blue-50 border-b border-gray-200">
                                    <tr>
                                        <th className="py-3 px-4 text-left text-sm font-semibold text-gray-700">评估年份</th>
                                        <th className="py-3 px-4 text-left text-sm font-semibold text-gray-700">部门</th>
                                        <th className="py-3 px-4 text-left text-sm font-semibold text-gray-700">风险类型</th>
                                        <th className="py-3 px-4 text-left text-sm font-semibold text-gray-700">评估状态</th>
                                        <th className="py-3 px-4 text-left text-sm font-semibold text-gray-700">最终分数</th>
                                        <th className="py-3 px-4 text-left text-sm font-semibold text-gray-700">详情</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredReports.map(report => {
                                        const { totalWeightedScore } = calculateScores(report.content);
                                        return (
                                            <tr key={report.id} className="border-b border-gray-100 hover:bg-gray-50">
                                                <td className="py-3 px-4 text-sm text-gray-800">{report.year}</td>
                                                <td className="py-3 px-4 text-sm text-gray-800">{report.department}</td>
                                                <td className="py-3 px-4 text-sm text-gray-800">{report.riskType}</td>
                                                <td className="py-3 px-4 text-sm">
                                                    <span className={`px-2 py-1 rounded-full text-xs font-semibold ${
                                                        report.status === '已复核' ? 'bg-green-100 text-green-800' :
                                                        report.status === '待修改' ? 'bg-red-100 text-red-800' :
                                                        'bg-orange-100 text-orange-800'
                                                    }`}>
                                                        {report.status}
                                                    </span>
                                                </td>
                                                <td className="py-3 px-4 text-sm text-gray-800">{totalWeightedScore.toFixed(2)}</td>
                                                <td className="py-3 px-4 text-sm">
                                                    {/* Placeholder for viewing full details */}
                                                    <button
                                                        onClick={() => alert(`查看 ${report.year} 年 ${report.riskType} 报告详情 (ID: ${report.id})`)}
                                                        className="text-blue-600 hover:underline text-sm"
                                                    >
                                                        查看
                                                    </button>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        // 8. 可视化热力图
        const OverviewHeatmap = ({ assessments }) => {
            const allYears = [...new Set(assessments.map(a => a.year))].sort((a, b) => b - a);
            const allRiskTypes = [...new Set(assessments.map(a => a.riskType))].sort();

            const [selectedYear, setSelectedYear] = React.useState('');
            const [selectedRiskType, setSelectedRiskType] = React.useState('');

            // Prepare heatmap data
            const heatmapData = {};
            const yearsInView = selectedYear ? [parseInt(selectedYear)] : allYears;
            const riskTypesInView = selectedRiskType ? [selectedRiskType] : allRiskTypes;

            yearsInView.forEach(year => {
                heatmapData[year] = {};
                riskTypesInView.forEach(riskType => {
                    const relevantAssessment = assessments.find(
                        a => a.year === year && a.riskType === riskType && a.status === '已复核'
                    );
                    if (relevantAssessment) {
                        const { totalWeightedScore } = calculateScores(relevantAssessment.content);
                        heatmapData[year][riskType] = totalWeightedScore;
                    } else {
                        heatmapData[year][riskType] = null; // No data for this year/risk type
                    }
                });
            });

            // Determine heatmap cell color based on score (5-1 scale where lower score is higher risk)
            const getHeatmapColor = (score) => {
                if (score === null) return 'bg-gray-200 text-gray-600'; // No data
                if (score >= 4.5) return 'bg-green-600 text-white'; // 很强 (Very Strong, Low Risk)
                if (score >= 3.5) return 'bg-lime-500 text-white'; // 较强 (Stronger)
                if (score >= 2.5) return 'bg-yellow-400 text-gray-800'; // 中等 (Medium)
                if (score >= 1.5) return 'bg-orange-500 text-white'; // 较弱 (Weaker)
                return 'bg-red-600 text-white'; // 很弱 (Very Weak, High Risk)
            };

            const handleExportHeatmap = () => {
                // This would typically involve rendering the chart to a canvas/SVG and then exporting.
                // For this prototype, we'll simulate it.
                alert('热力图导出功能（PNG/PDF）待实现，已模拟导出。');
            };

            return (
                <div className="p-6 bg-white rounded-2xl shadow-xl">
                    <h2 className="text-3xl font-extrabold text-gray-900 mb-6">评估结果概览 (热力图)</h2>

                    <div className="flex flex-wrap gap-4 mb-6 p-4 border border-gray-200 rounded-xl bg-gray-50">
                        <div className="flex-1 min-w-[150px]">
                            <label htmlFor="heatmap-year-filter" className="block text-sm font-medium text-gray-700 mb-1">年份筛选:</label>
                            <select
                                id="heatmap-year-filter"
                                className="w-full p-2 border border-gray-300 rounded-xl shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                value={selectedYear}
                                onChange={(e) => setSelectedYear(e.target.value)}
                            >
                                <option value="">所有年份</option>
                                {allYears.map(year => (
                                    <option key={year} value={year}>{year}</option>
                                ))}
                            </select>
                        </div>
                        <div className="flex-1 min-w-[150px]">
                            <label htmlFor="heatmap-risk-type-filter" className="block text-sm font-medium text-gray-700 mb-1">风险类型筛选:</label>
                            <select
                                id="heatmap-risk-type-filter"
                                className="w-full p-2 border border-gray-300 rounded-xl shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                value={selectedRiskType}
                                onChange={(e) => setSelectedRiskType(e.target.value)}
                            >
                                <option value="">所有风险类型</option>
                                {allRiskTypes.map(type => (
                                    <option key={type} value={type}>{type}</option>
                                ))}
                            </select>
                        </div>
                        <div className="w-full sm:w-auto mt-4 sm:mt-0">
                            <button
                                onClick={handleExportHeatmap}
                                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-xl shadow-md transition-all duration-300 transform hover:scale-105"
                            >
                                一键导出热力图
                            </button>
                        </div>
                    </div>

                    <div className="legend mb-6 flex flex-wrap gap-3 text-sm">
                        <span className="font-semibold text-gray-700">风险等级图例:</span>
                        <span className="flex items-center"><span className="w-4 h-4 inline-block mr-1 rounded-sm bg-red-600"></span>高风险 (低分)</span>
                        <span className="flex items-center"><span className="w-4 h-4 inline-block mr-1 rounded-sm bg-orange-500"></span>较高风险</span>
                        <span className="flex items-center"><span className="w-4 h-4 inline-block mr-1 rounded-sm bg-yellow-400"></span>中等风险</span>
                        <span className="flex items-center"><span className="w-4 h-4 inline-block mr-1 rounded-sm bg-lime-500"></span>较低风险</span>
                        <span className="flex items-center"><span className="w-4 h-4 inline-block mr-1 rounded-sm bg-green-600"></span>低风险 (高分)</span>
                        <span className="flex items-center"><span className="w-4 h-4 inline-block mr-1 rounded-sm bg-gray-200"></span>无数据</span>
                    </div>

                    <div className="overflow-x-auto">
                        <table className="min-w-full bg-white rounded-xl shadow-md border border-gray-200">
                            <thead className="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th className="py-3 px-4 text-left text-sm font-semibold text-gray-700">年份 / 风险类型</th>
                                    {riskTypesInView.map(riskType => (
                                        <th key={riskType} className="py-3 px-4 text-center text-sm font-semibold text-gray-700">{riskType}</th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>
                                {yearsInView.map(year => (
                                    <tr key={year} className="border-b border-gray-100">
                                        <td className="py-3 px-4 text-left text-sm font-semibold text-gray-800 bg-blue-50">{year}</td>
                                        {riskTypesInView.map(riskType => {
                                            const score = heatmapData[year]?.[riskType];
                                            return (
                                                <td key={`${year}-${riskType}`} className={`py-3 px-4 text-center text-lg font-bold ${getHeatmapColor(score)} rounded-md m-1 transition-colors duration-200`}>
                                                    {score !== null ? score.toFixed(2) : '-'}
                                                </td>
                                            );
                                        })}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // Main App Component
        function App() {
            const [user, setUser] = React.useState(null); // { role: 'RM' | 'Department', name: '...', department?: '...' }
            const [currentView, setCurrentView] = React.useState('login'); // login, templateManagement, assessmentFill, review, historicalReports, overview
            const [templates, setTemplates] = React.useState(mockTemplates);
            const [assessments, setAssessments] = React.useState(mockAssessments);
            const [notifications, setNotifications] = React.useState([]);

            React.useEffect(() => {
                // Simulate initial notifications for the logged-in user if any
                if (user && user.role === 'Department') {
                    const departmentTasks = assessments.filter(a => a.department === user.department && (a.status === '待填写' || a.status === '待修改'));
                    const initialNotifs = departmentTasks.map(task => ({
                        type: 'new-task',
                        message: `您有新的 ${task.year} 年 ${task.riskType} 评估任务待处理！`,
                        link: `/assessment/${task.id}`,
                    }));
                    setNotifications(initialNotifs);
                } else {
                    setNotifications([]);
                }
            }, [user, assessments]);


            const handleLogin = (loggedInUser) => {
                setUser(loggedInUser);
                if (loggedInUser.role === 'RM') {
                    setCurrentView('templateManagement');
                } else if (loggedInUser.role === 'Department') {
                    setCurrentView('assessmentFill');
                }
            };

            const NavItem = ({ viewName, label, requiredRole }) => {
                if (user?.role !== requiredRole && requiredRole !== 'all') {
                    return null;
                }
                return (
                    <li className="mb-2">
                        <button
                            onClick={() => setCurrentView(viewName)}
                            className={`w-full text-left py-3 px-4 rounded-xl text-lg font-medium transition-all duration-300
                                ${currentView === viewName ? 'bg-blue-700 text-white shadow-md' : 'text-blue-100 hover:bg-blue-600'}`}
                        >
                            {label}
                        </button>
                    </li>
                );
            };

            return (
                <div className="min-h-screen bg-gray-100 flex font-inter">
                    {/* Left Sidebar */}
                    <aside className="w-64 bg-blue-800 text-white p-6 shadow-lg flex flex-col">
                        <h1 className="text-3xl font-extrabold mb-8 text-center">风险管理系统</h1>
                        {user && <p className="text-xl font-semibold mb-6 text-center">{user.name}</p>}

                        <nav className="flex-grow">
                            <ul className="space-y-4">
                                <li>
                                    <h3 className="text-lg font-bold text-blue-200 mb-2">风险评估管理模块</h3>
                                    <ul className="pl-4">
                                        <NavItem viewName="assessmentFill" label="评估任务填写" requiredRole="Department" />
                                        <NavItem viewName="review" label="风险评估管理" requiredRole="RM" /> {/* Label updated */}
                                        <NavItem viewName="templateManagement" label="评估模板管理" requiredRole="RM" />
                                        <NavItem viewName="historicalReports" label="查看历史评估报告" requiredRole="all" />
                                    </ul>
                                </li>
                                <li className="mt-6">
                                    <h3 className="text-lg font-bold text-blue-200 mb-2">评估结果概览模块</h3>
                                    <ul className="pl-4">
                                        <NavItem viewName="overview" label="风险热力图" requiredRole="all" />
                                    </ul>
                                </li>
                            </ul>
                        </nav>
                        {user && (
                            <button
                                onClick={() => setUser(null)}
                                className="mt-auto w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl shadow-md transition-all duration-300"
                            >
                                注销
                            </button>
                        )}
                    </aside>

                    {/* Main Content Area */}
                    <main className="flex-1 p-8 relative">
                        <NotificationBar notifications={notifications} />

                        {user ? (
                            <>
                                {currentView === 'templateManagement' &&
                                    <RMTemplateManagement
                                        user={user}
                                        templates={templates}
                                        setTemplates={setTemplates}
                                        setAssessments={setAssessments}
                                        allAssessments={assessments}
                                        setNotifications={setNotifications}
                                        setCurrentView={setCurrentView}
                                    />}
                                {currentView === 'assessmentFill' &&
                                    <DepartmentAssessment
                                        user={user}
                                        assessments={assessments}
                                        setAssessments={setAssessments}
                                        setCurrentView={setCurrentView}
                                    />}
                                {currentView === 'review' &&
                                    <RMReview
                                        user={user}
                                        assessments={assessments}
                                        setAssessments={setAssessments}
                                        setNotifications={setNotifications}
                                        setCurrentView={setCurrentView}
                                    />}
                                {currentView === 'historicalReports' &&
                                    <HistoricalReports
                                        user={user}
                                        assessments={assessments}
                                    />}
                                {currentView === 'overview' &&
                                    <OverviewHeatmap
                                        assessments={assessments}
                                    />}
                            </>
                        ) : (
                            <Login onLogin={handleLogin} />
                        )}
                    </main>
                </div>
            );
        }

        // 渲染 React App
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risk Assessment System</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- React and ReactDOM CDNs -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            /* Removed overflow: hidden; to allow scrolling */
        }
        /* Custom styles for Lucide icons */
        .lucide {
            display: inline-block;
            vertical-align: middle;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root" class="flex h-screen bg-gray-100 font-sans"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Dummy Save icon as it's not directly from lucide-react in HTML context
        const SaveIcon = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
            </svg>
        );

        // Define Lucide icons as components for JSX
        const Home = (props) => <i className="lucide lucide-home" {...props} />;
        const ClipboardList = (props) => <i className="lucide lucide-clipboard-list" {...props} />;
        const TrendingUp = (props) => <i className="lucide lucide-trending-up" {...props} />;
        const FolderEdit = (props) => <i className="lucide lucide-folder-edit" {...props} />;
        const LayoutDashboard = (props) => <i className="lucide lucide-layout-dashboard" {...props} />;
        const Settings = (props) => <i className="lucide lucide-settings" {...props} />;
        const User = (props) => <i className="lucide lucide-user" {...props} />;
        const CheckCircle = (props) => <i className="lucide lucide-check-circle" {...props} />;
        const XCircle = (props) => <i className="lucide lucide-x-circle" {...props} />;
        const Clock = (props) => <i className="lucide lucide-clock" {...props} />;
        const FileText = (props) => <i className="lucide lucide-file-text" {...props} />;
        const Download = (props) => <i className="lucide lucide-download" {...props} />;
        const Edit = (props) => <i className="lucide lucide-edit" {...props} />;
        const Send = (props) => <i className="lucide lucide-send" {...props} />;
        const MessageSquareText = (props) => <i className="lucide lucide-message-square-text" {...props} />;
        const Search = (props) => <i className="lucide lucide-search" {...props} />;
        const PlusCircle = (props) => <i className="lucide lucide-plus-circle" {...props} />;
        const Copy = (props) => <i className="lucide lucide-copy" {...props} />;
        const BarChart3 = (props) => <i className="lucide lucide-bar-chart-3" {...props} />;
        const ChevronRight = (props) => <i className="lucide lucide-chevron-right" {...props} />;
        const ChevronDown = (props) => <i className="lucide lucide-chevron-down" {...props} />;
        const RefreshCcw = (props) => <i className="lucide lucide-refresh-ccw" {...props} />;
        const Save = SaveIcon; // Map custom SaveIcon to Save

        function App() {
            const [userRole, setUserRole] = useState('RM'); // 'RM' or 'ASSESSOR'
            const [currentView, setCurrentView] = useState('progressOverview'); // Changed initial view to progressOverview
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [expandedMenu, setExpandedMenu] = useState('');

            // Dummy Data for simulation
            const [assessmentTemplates, setAssessmentTemplates] = useState([
                {
                    id: 'template-2024',
                    year: 2024,
                    name: '2024 Annual Risk Assessment Template',
                    categories: [
                        {
                            name: 'Governance Structure',
                            weight: 20,
                            items: [
                                { id: 'item-1-1', description: 'Is the company\'s governance structure sound and are responsibilities clearly defined?', ref: 'Internal Policy A', assignedDepartment: 'All Departments' },
                                { id: 'item-1-2', description: 'Do the board and management regularly review risk management policies?', ref: 'Internal Policy B', assignedDepartment: 'Board Office' },
                            ]
                        },
                        {
                            name: 'Strategy Preference and Limits',
                            weight: 25,
                            items: [
                                { id: 'item-2-1', description: 'Has the risk appetite statement been approved and effectively communicated?', ref: 'Policy Document C', assignedDepartment: 'All Departments' },
                                { id: 'item-2-2', description: 'Are risk limits clear and regularly monitored?', ref: 'Policy Document D', assignedDepartment: 'Finance Department' },
                            ]
                        },
                        {
                            name: 'Policies and Procedures',
                            weight: 20,
                            items: [
                                { id: 'item-3-1', description: 'Are risk management policies and procedures up-to-date and easily accessible?', ref: 'Operation Manual E', assignedDepartment: 'All Departments' },
                                { id: 'item-3-2', description: 'Is regular training provided to ensure employees understand policies?', ref: 'Training Guide F', assignedDepartment: 'Human Resources Department' },
                            ]
                        },
                        {
                            name: 'Systems and Data',
                            weight: 15,
                            items: [
                                { id: 'item-4-1', description: 'Is the risk management system stable and effectively supporting decision-making?', ref: 'IT Policy G', assignedDepartment: 'IT Department' },
                                { id: 'item-4-2', description: 'Is risk data accurate, complete, and timely?', ref: 'Data Management H', assignedDepartment: 'Data Center' },
                            ]
                        },
                        {
                            name: 'Internal Control and Audit',
                            weight: 20,
                            items: [
                                { id: 'item-5-1', description: 'Is the internal control system sound and effective?', ref: 'Internal Control Manual I', assignedDepartment: 'Audit Department' },
                                { id: 'item-5-2', description: 'Is internal audit independent and does it regularly assess risk management?', ref: 'Audit Charter J', assignedDepartment: 'Audit Department' },
                            ]
                        },
                    ],
                    annualSummaryQuestions: [
                        'Annual Work Achievements',
                        'Problems or Deficiencies Encountered This Year',
                        'Next Year\'s Work Plan',
                    ]
                },
                {
                    id: 'template-2023',
                    year: 2023,
                    name: '2023 Annual Risk Assessment Template',
                    categories: [
                        {
                            name: 'Governance Structure',
                            weight: 20,
                            items: [
                                { id: 'item-a-1', description: 'Is the company\'s governance structure sound and are responsibilities clearly defined?', ref: 'Internal Policy A', assignedDepartment: 'All Departments' },
                            ]
                        },
                        {
                            name: 'Strategy Preference and Limits',
                            weight: 25,
                            items: [
                                { id: 'item-b-1', description: 'Has the risk appetite statement been approved and effectively communicated?', ref: 'Policy Document C', assignedDepartment: 'All Departments' },
                            ]
                        },
                    ],
                    annualSummaryQuestions: [
                        'Annual Work Achievements',
                        'Problems or Deficiencies Encountered This Year',
                        'Next Year\'s Work Plan',
                    ]
                },
            ]);

            const [assessmentTasks, setAssessmentTasks] = useState([
                {
                    id: 'task-001',
                    templateId: 'template-2024',
                    year: 2024,
                    riskType: 'Strategic Risk',
                    department: 'Marketing Department',
                    status: 'Pending Completion', // Pending Completion, Submitted, Rejected, Reviewed
                    // Added example data for task-001
                    data: {
                        'item-1-1': { score: 4, explanation: 'The company\'s governance structure is sound, departmental responsibilities are clear, and it effectively supports risk management.', files: [], rmComment: '', history: [{ timestamp: '2024-06-27 10:00:00', editor: 'ASSESSOR', score: 4, explanation: 'The company\'s governance structure is sound, departmental responsibilities are clear, and it effectively supports risk management.', rmComment: '' }] },
                        'item-1-2': { score: 3, explanation: 'The board and management regularly review risk management policies, but meeting frequency could be increased to respond to rapidly changing markets.', files: [], rmComment: '', history: [{ timestamp: '2024-06-27 10:05:00', editor: 'ASSESSOR', score: 3, explanation: 'The board and management regularly review risk management policies, but meeting frequency could be increased to respond to rapidly changing markets.', rmComment: '' }] },
                        'item-2-1': { score: 5, explanation: 'The risk appetite statement has been fully communicated to all levels of employees through internal training and briefings, with high understanding.', files: [], rmComment: '', history: [{ timestamp: '2024-06-27 10:10:00', editor: 'ASSESSOR', score: 5, explanation: 'The risk appetite statement has been fully communicated to all levels of employees through internal training and briefings, with high understanding.', rmComment: '' }] },
                        'annual-summary-0': 'This year, the Marketing Department completed market research and risk assessment for the new product line, successfully avoiding potential market entry risks.',
                        'annual-summary-1': 'During new market expansion, there was a lag in understanding local policies and regulations, leading to some business delays.',
                        'annual-summary-2': 'Next year, we plan to strengthen the international market legal advisory team and introduce a risk early warning system to enhance market risk identification capabilities.',
                    },
                    comments: [],
                },
                {
                    id: 'task-002',
                    templateId: 'template-2024',
                    year: 2024,
                    riskType: 'Compliance Risk',
                    department: 'Legal Department',
                    status: 'Submitted',
                    data: {
                        'item-1-1': { score: 4, explanation: 'Good governance structure, clear division of responsibilities.', files: [], rmComment: '', history: [{ timestamp: '2024-06-27 09:00:00', editor: 'ASSESSOR', score: 4, explanation: 'Good governance structure, clear division of responsibilities.', rmComment: '' }] },
                        'item-1-2': { score: 3, explanation: 'Board conducts regular reviews, but efficiency needs improvement.', files: [], rmComment: '', history: [{ timestamp: '2024-06-27 09:05:00', editor: 'ASSESSOR', score: 3, explanation: 'Board conducts regular reviews, but efficiency needs improvement.', rmComment: '' }] },
                        'item-2-1': { score: 5, explanation: 'Risk appetite statement fully communicated.', files: [], rmComment: '', history: [{ timestamp: '2024-06-27 09:10:00', editor: 'ASSESSOR', score: 5, explanation: 'Risk appetite statement fully communicated.', rmComment: '' }] },
                        'annual-summary-0': 'Completed annual legal risk self-inspection, compliance system further improved.',
                        'annual-summary-1': 'Contract approval process still has efficiency bottlenecks.',
                        'annual-summary-2': 'Next year\'s plan is to introduce an AI-assisted contract review system.',
                    },
                    comments: [],
                },
                {
                    id: 'task-003',
                    templateId: 'template-2024',
                    year: 2024,
                    riskType: 'Market Risk',
                    department: 'Sales Department',
                    status: 'Rejected',
                    data: {
                        'item-1-1': { score: 3, explanation: 'Responsibilities of some regional market managers are unclear.', files: [], rmComment: 'RM believes this explanation is not specific enough, please elaborate.', history: [{ timestamp: '2024-06-27 09:20:00', editor: 'ASSESSOR', score: 3, explanation: 'Responsibilities of some regional market managers are unclear.', rmComment: '' }, { timestamp: '2024-06-27 10:30:00', editor: 'RM', score: 3, explanation: 'Responsibilities of some regional market managers are unclear.', rmComment: 'RM believes this explanation is not specific enough, please elaborate.' }] },
                        'annual-summary-0': 'Sales reached expectations, market share stable.',
                        'annual-summary-1': 'New product promotion encountered obstacles, market feedback below expectations.',
                        'annual-summary-2': 'Next year\'s plan is to strengthen market research and adjust product strategy.',
                    },
                    comments: [{ from: 'RM', text: 'Please provide specific regions and problem descriptions.', timestamp: new Date().toLocaleString() }],
                },
                {
                    id: 'task-004',
                    templateId: 'template-2024',
                    year: 2024,
                    riskType: 'Strategic Risk',
                    department: 'Senior Management',
                    status: 'Reviewed',
                    data: {
                        'item-1-1': { score: 5, explanation: 'Company strategic goals are clear, and execution at all levels is strong.', files: [], rmComment: 'This assessment is accurate, no objection.', history: [{ timestamp: '2024-06-27 09:40:00', editor: 'ASSESSOR', score: 5, explanation: 'Company strategic goals are clear, and execution at all levels is strong.', rmComment: '' }, { timestamp: '2024-06-27 11:00:00', editor: 'RM', score: 5, explanation: 'Company strategic goals are clear, and execution at all levels is strong.', rmComment: 'This assessment is accurate, no objection.' }] },
                        'annual-summary-0': 'Annual strategic goals fully achieved.',
                        'annual-summary-1': 'International market expansion faces cultural differences challenges.',
                        'annual-summary-2': 'Next year\'s plan is to deepen localization strategy and strengthen international cooperation.',
                    },
                    comments: [{ from: 'RM', text: 'Review passed, report content is detailed.', timestamp: new Date().toLocaleString() }],
                },
            ]);

            const departments = ['Marketing Department', 'Legal Department', 'Sales Department', 'Human Resources Department', 'IT Department', 'Finance Department', 'Board Office', 'Data Center', 'Audit Department', 'Senior Management'];
            const riskTypes = ['Strategic Risk', 'Compliance Risk', 'Market Risk', 'Operational Risk', 'Financial Risk'];
            const assessmentYears = [2024, 2023, 2022, 2021];
            const assessmentCategories = ['Governance Structure', 'Strategy Preference and Limits', 'Policies and Procedures', 'Systems and Data', 'Internal Control and Audit'];

            const calculateProgress = (tasks) => {
                if (tasks.length === 0) return 0;
                const completedTasks = tasks.filter(task => task.status === 'Reviewed').length;
                return Math.round((completedTasks / tasks.length) * 100);
            };

            const getDepartmentProgress = (department) => {
                const departmentTasks = assessmentTasks.filter(task => task.department === department);
                return calculateProgress(departmentTasks);
            };

            const getOverallProgress = () => {
                return calculateProgress(assessmentTasks);
            };

            const Sidebar = () => (
                <div className={`bg-gray-800 text-white flex flex-col transition-all duration-300 ${isSidebarOpen ? 'w-64' : 'w-20'} h-screen rounded-r-xl shadow-lg`}>
                    <div className="flex items-center justify-between p-4 bg-gray-900 rounded-tr-xl">
                        {isSidebarOpen && <h1 className="text-xl font-bold text-teal-400">Risk Assessment System</h1>}
                        <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-2 rounded-full hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-teal-500">
                            {isSidebarOpen ? <ChevronRight size={20} /> : <ChevronDown size={20} />}
                        </button>
                    </div>
                    <nav className="flex-1 overflow-y-auto mt-2">
                        <CollapsibleNavItem
                            icon={<ClipboardList size={20} />}
                            text="Historical Assessment Records"
                            isSidebarOpen={isSidebarOpen}
                            expanded={expandedMenu === 'history'}
                            setExpanded={() => setExpandedMenu(expandedMenu === 'history' ? '' : 'history')}
                        >
                            <SubNavItem
                                text="Self-Assessment Report Records"
                                target="historicalReports"
                                isSidebarOpen={isSidebarOpen}
                                onClick={() => setCurrentView('historicalReports')}
                            />
                            <SubNavItem
                                text="Risk Heatmap Records"
                                target="heatmapRecords"
                                isSidebarOpen={isSidebarOpen}
                                onClick={() => setCurrentView('heatmapRecords')}
                            />
                        </CollapsibleNavItem>

                        <CollapsibleNavItem
                            icon={<FolderEdit size={20} />}
                            text="Current Assessment Management"
                            isSidebarOpen={isSidebarOpen}
                            expanded={expandedMenu === 'current'}
                            setExpanded={() => setExpandedMenu(expandedMenu === 'current' ? '' : 'current')}
                        >
                            {userRole === 'RM' && (
                                <SubNavItem
                                    text="Assessment Template Management"
                                    target="templateManagement"
                                    isSidebarOpen={isSidebarOpen}
                                    onClick={() => setCurrentView('templateManagement')}
                                />
                            )}
                            <SubNavItem
                                text="Risk Assessment Completion"
                                target="riskAssessmentFill"
                                isSidebarOpen={isSidebarOpen}
                                onClick={() => setCurrentView('riskAssessmentFill')}
                            />
                            {userRole === 'RM' && (
                                <SubNavItem
                                    text="Risk Assessment Review"
                                    target="riskAssessmentReview"
                                    isSidebarOpen={isSidebarOpen}
                                    onClick={() => setCurrentView('riskAssessmentReview')}
                                />
                            )}
                            <SubNavItem
                                text="Assessment Progress Overview"
                                target="progressOverview"
                                isSidebarOpen={isSidebarOpen}
                                onClick={() => setCurrentView('progressOverview')}
                            />
                        </CollapsibleNavItem>
                    </nav>
                    <div className="p-4 border-t border-gray-700">
                        <button
                            onClick={() => setUserRole(userRole === 'RM' ? 'ASSESSOR' : 'RM')}
                            className="flex items-center w-full px-3 py-2 rounded-lg text-sm font-medium text-left transition-colors duration-200 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-teal-500"
                        >
                            <User size={18} className="mr-3" />
                            {isSidebarOpen ? (userRole === 'RM' ? 'Switch to Department Assessor' : 'Switch to Risk Management Dept') : ''}
                        </button>
                    </div>
                </div>
            );

            const NavItem = ({ icon, text, target, isSidebarOpen, onClick }) => (
                <button
                    onClick={onClick}
                    className={`flex items-center w-full px-4 py-3 rounded-lg text-left transition-colors duration-200 ${currentView === target ? 'bg-teal-600 text-white' : 'hover:bg-gray-700'}`}
                >
                    {icon}
                    {isSidebarOpen && <span className="ml-3 text-base">{text}</span>}
                </button>
            );

            const CollapsibleNavItem = ({ icon, text, isSidebarOpen, expanded, setExpanded, children }) => (
                <div>
                    <button
                        onClick={setExpanded}
                        className={`flex items-center w-full px-4 py-3 rounded-lg text-left transition-colors duration-200 hover:bg-gray-700`}
                    >
                        {icon}
                        {isSidebarOpen && (
                            <span className="ml-3 text-base flex-1">{text}</span>
                        )}
                        {isSidebarOpen && (expanded ? <ChevronDown size={16} /> : <ChevronRight size={16} />)}
                    </button>
                    {isSidebarOpen && expanded && (
                        <div className="ml-6 border-l border-gray-600 pl-2">
                            {children}
                        </div>
                    )}
                </div>
            );

            const SubNavItem = ({ text, target, isSidebarOpen, onClick }) => (
                <button
                    onClick={onClick}
                    className={`flex items-center w-full px-3 py-2 rounded-lg text-left transition-colors duration-200 ${currentView === target ? 'bg-teal-700 text-white' : 'hover:bg-gray-600'} text-sm`}
                >
                    {isSidebarOpen && <span className="ml-3">{text}</span>}
                </button>
            );

            const HistoricalReports = () => {
                const [selectedYear, setSelectedYear] = useState('');
                const [selectedRiskType, setSelectedRiskType] = useState('');

                const filteredReports = assessmentTasks.filter(task => {
                    const matchesYear = selectedYear ? task.year.toString() === selectedYear : true;
                    const matchesRiskType = selectedRiskType ? task.riskType === selectedRiskType : true;
                    const matchesRole = userRole === 'RM' || task.department === 'Legal Department'; // Dept assessor only sees their department
                    return task.status === 'Reviewed' && matchesYear && matchesRiskType && matchesRole;
                });

                return (
                    <div className="p-8 bg-gray-50 flex-1 overflow-auto rounded-xl shadow-lg">
                        <h2 className="text-3xl font-extrabold text-gray-800 mb-6 border-b-2 pb-2 border-teal-500">Self-Assessment Report Records</h2>
                        <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label htmlFor="year-filter" className="block text-sm font-medium text-gray-700 mb-1">Year</label>
                                    <select
                                        id="year-filter"
                                        className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm rounded-md"
                                        value={selectedYear}
                                        onChange={(e) => setSelectedYear(e.target.value)}
                                    >
                                        <option value="">All Years</option>
                                        {assessmentYears.map(year => <option key={year} value={year}>{year}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label htmlFor="risk-type-filter" className="block text-sm font-medium text-gray-700 mb-1">Risk Type</label>
                                    <select
                                        id="risk-type-filter"
                                        className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm rounded-md"
                                        value={selectedRiskType}
                                        onChange={(e) => setSelectedRiskType(e.target.value)}
                                    >
                                        <option value="">All Types</option>
                                        {riskTypes.map(type => <option key={type} value={type}>{type}</option>)}
                                    </select>
                                </div>
                            </div>
                            <button className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">
                                <Download size={18} className="mr-2" />
                                Export Report (Word/PDF)
                            </button>
                        </div>

                        <div className="overflow-x-auto rounded-lg shadow">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assessment Year</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Risk Type</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {filteredReports.length === 0 ? (
                                        <tr>
                                            <td colSpan="5" className="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">No Data</td>
                                        </tr>
                                    ) : (
                                        filteredReports.map(report => (
                                            <tr key={report.id}>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{report.year}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{report.riskType}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{report.department}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm">
                                                    <span className="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                                        {report.status}
                                                    </span>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                    <button onClick={() => alert(`View ${report.year} ${report.riskType} Report Details`)} className="text-teal-600 hover:text-teal-900">
                                                        View Report
                                                    </button>
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            const RiskHeatmapRecords = () => {
                const [selectedYear, setSelectedYear] = useState('2024');
                const [selectedRiskCategory, setSelectedRiskCategory] = useState('');

                // Dummy data for heatmap scores
                const heatmapData = {
                    2024: {
                        'Strategic Risk': { 'Governance Structure': 3, 'Strategy Preference and Limits': 4, 'Policies and Procedures': 2, 'Systems and Data': 3, 'Internal Control and Audit': 4 },
                        'Compliance Risk': { 'Governance Structure': 2, 'Strategy Preference and Limits': 3, 'Policies and Procedures': 4, 'Systems and Data': 3, 'Internal Control and Audit': 3 },
                        'Market Risk': { 'Governance Structure': 4, 'Strategy Preference and Limits': 3, 'Policies and Procedures': 2, 'Systems and Data': 4, 'Internal Control and Audit': 3 },
                        'Operational Risk': { 'Governance Structure': 3, 'Strategy Preference and Limits': 2, 'Policies and Procedures': 3, 'Systems and Data': 4, 'Internal Control and Audit': 3 },
                        'Financial Risk': { 'Governance Structure': 2, 'Strategy Preference and Limits': 3, 'Policies and Procedures': 3, 'Systems and Data': 2, 'Internal Control and Audit': 4 },
                    },
                    2023: {
                        'Strategic Risk': { 'Governance Structure': 2, 'Strategy Preference and Limits': 3, 'Policies and Procedures': 3, 'Systems and Data': 4, 'Internal Control and Audit': 3 },
                        'Compliance Risk': { 'Governance Structure': 3, 'Strategy Preference and Limits': 2, 'Policies and Procedures': 3, 'Systems and Data': 4, 'Internal Control and Audit': 2 },
                    }
                };

                const currentHeatmap = heatmapData[selectedYear] || {};
                const categoriesForHeatmap = Object.keys(currentHeatmap);

                const getScoreColor = (score) => {
                    if (!score) return 'bg-gray-200 text-gray-700'; // No data
                    if (score >= 4) return 'bg-red-600 text-white'; // High risk
                    if (score === 3) return 'bg-orange-400 text-white'; // Medium risk
                    if (score <= 2) return 'bg-green-500 text-white'; // Low risk
                    return 'bg-gray-200 text-gray-700';
                };

                // Calculation logic for total score
                const calculateOverallScore = (year, category) => {
                    const template = assessmentTemplates.find(t => t.year.toString() === year);
                    if (!template || !currentHeatmap[category]) return 'N/A';

                    let totalWeightedScore = 0;
                    let totalWeight = 0;

                    template.categories.forEach(cat => {
                        const categoryScore = currentHeatmap[category]?.[cat.name];
                        if (categoryScore !== undefined) {
                            totalWeightedScore += categoryScore * (cat.weight / 100);
                            totalWeight += (cat.weight / 100);
                        }
                    });
                    return totalWeight > 0 ? (totalWeightedScore / totalWeight).toFixed(1) : 'N/A';
                };


                return (
                    <div className="p-8 bg-gray-50 flex-1 overflow-auto rounded-xl shadow-lg">
                        <h2 className="text-3xl font-extrabold text-gray-800 mb-6 border-b-2 pb-2 border-teal-500">Risk Heatmap Records</h2>
                        <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label htmlFor="year-filter" className="block text-sm font-medium text-gray-700 mb-1">Assessment Year</label>
                                    <select
                                        id="year-filter"
                                        className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm rounded-md"
                                        value={selectedYear}
                                        onChange={(e) => setSelectedYear(e.target.value)}
                                    >
                                        {assessmentYears.map(year => <option key={year} value={year}>{year}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label htmlFor="risk-category-filter" className="block text-sm font-medium text-gray-700 mb-1">Risk Category</label>
                                    <select
                                        id="risk-category-filter"
                                        className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm rounded-md"
                                        value={selectedRiskCategory}
                                        onChange={(e) => setSelectedRiskCategory(e.target.value)}
                                    >
                                        <option value="">All Categories</option>
                                        {riskTypes.map(type => <option key={type} value={type}>{type}</option>)}
                                    </select>
                                </div>
                            </div>
                            <div className="mb-4">
                                <h4 className="text-lg font-semibold text-gray-800 mb-2">Legend:</h4>
                                <div className="flex space-x-4">
                                    <div className="flex items-center">
                                        <span className="w-6 h-6 rounded-md bg-green-500 mr-2"></span>
                                        <span className="text-sm text-gray-700">Low Risk (1-2 points)</span>
                                    </div>
                                    <div className="flex items-center">
                                        <span className="w-6 h-6 rounded-md bg-orange-400 mr-2"></span>
                                        <span className="text-sm text-gray-700">Medium Risk (3 points)</span>
                                    </div>
                                    <div className="flex items-center">
                                        <span className="w-6 h-6 rounded-md bg-red-600 mr-2"></span>
                                        <span className="text-sm text-gray-700">High Risk (4-5 points)</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="overflow-x-auto rounded-lg shadow">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Risk Type</th>
                                        {assessmentCategories.map(cat => (
                                            <th key={cat} className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">{cat}</th>
                                        ))}
                                        <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Total Self-Assessment Score</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {categoriesForHeatmap
                                        .filter(cat => selectedRiskCategory ? cat === selectedRiskCategory : true)
                                        .map(riskCat => (
                                            <tr key={riskCat}>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{riskCat}</td>
                                                {assessmentCategories.map(subCat => (
                                                    <td key={subCat} className={`px-6 py-4 whitespace-nowrap text-sm text-center ${getScoreColor(currentHeatmap[riskCat]?.[subCat])}`}>
                                                        {currentHeatmap[riskCat]?.[subCat] || '-'}
                                                    </td>
                                                ))}
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-center font-bold text-gray-900">
                                                    {calculateOverallScore(selectedYear, riskCat)}
                                                </td>
                                            </tr>
                                        ))
                                    }
                                    {categoriesForHeatmap.filter(cat => selectedRiskCategory ? cat === selectedRiskCategory : true).length === 0 && (
                                        <tr>
                                            <td colSpan={assessmentCategories.length + 2} className="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">No Data</td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            const AssessmentTemplateManagement = () => {
                const [newTemplateYear, setNewTemplateYear] = useState('');
                const [selectedTemplate, setSelectedTemplate] = useState(assessmentTemplates[0]);
                const [isCreatingNewTemplate, setIsCreatingNewTemplate] = useState(false);
                const [showDetailModal, setShowDetailModal] = useState(false);
                const [modalContent, setModalContent] = useState('');
                const [copiedTemplateYear, setCopiedTemplateYear] = useState('');

                const handleCopyTemplate = () => {
                    if (!copiedTemplateYear) {
                        alert('Please select a year to copy from!');
                        return;
                    }
                    const sourceTemplate = assessmentTemplates.find(t => t.year.toString() === copiedTemplateYear);
                    if (sourceTemplate) {
                        const newTemplate = {
                            ...sourceTemplate,
                            id: `template-${newTemplateYear}`,
                            year: parseInt(newTemplateYear),
                            name: `${newTemplateYear} Annual Risk Assessment Template`,
                        };
                        setAssessmentTemplates([...assessmentTemplates, newTemplate]);
                        setNewTemplateYear('');
                        setCopiedTemplateYear('');
                        alert(`${newTemplateYear} template copied successfully from ${copiedTemplateYear}!`);
                    } else {
                        alert('Source template not found.');
                    }
                };

                const handleCreateTemplate = () => {
                    if (!newTemplateYear) {
                        alert('Please enter the template year!');
                        return;
                    }
                    const newTemplate = {
                        id: `template-${newTemplateYear}`,
                        year: parseInt(newTemplateYear),
                        name: `${newTemplateYear} Annual Risk Assessment Template`,
                        categories: assessmentCategories.map(cat => ({
                            name: cat,
                            weight: 20, // Default weight
                            items: [{ id: `${cat}-new`, description: 'New sub-assessment item description', ref: 'Policy Reference', assignedDepartment: 'All Departments' }]
                        })),
                        annualSummaryQuestions: [
                            'Annual Work Achievements',
                            'Problems or Deficiencies Encountered This Year',
                            'Next Year\'s Work Plan',
                        ]
                    };
                    setAssessmentTemplates([...assessmentTemplates, newTemplate]);
                    setSelectedTemplate(newTemplate);
                    setNewTemplateYear('');
                    setIsCreatingNewTemplate(false);
                    alert(`${newTemplateYear} annual new template created successfully!`);
                };

                const handleDistributeTasks = (templateId) => {
                    const template = assessmentTemplates.find(t => t.id === templateId);
                    if (template) {
                        // Simulate task distribution: create tasks for each risk type/department combination
                        const newTasks = [];
                        riskTypes.forEach(rType => {
                            departments.forEach(dept => {
                                // Only create if a task for this department/riskType for this year doesn't exist
                                const existingTask = assessmentTasks.find(t => t.year === template.year && t.riskType === rType && t.department === dept);
                                if (!existingTask) {
                                    newTasks.push({
                                        id: `task-${Date.now()}-${rType}-${dept}`,
                                        templateId: template.id,
                                        year: template.year,
                                        riskType: rType,
                                        department: dept,
                                        status: 'Pending Completion',
                                        data: {},
                                        comments: [],
                                    });
                                }
                            });
                        });
                        setAssessmentTasks([...assessmentTasks, ...newTasks]);
                        alert(`Assessment tasks for ${template.year} have been distributed to all departments!`);
                    }
                };

                const handleUpdateCategoryWeight = (categoryName, newWeight) => {
                    const updatedTemplate = { ...selectedTemplate };
                    updatedTemplate.categories = updatedTemplate.categories.map(cat =>
                        cat.name === categoryName ? { ...cat, weight: parseInt(newWeight) } : cat
                    );
                    setSelectedTemplate(updatedTemplate);
                    setAssessmentTemplates(assessmentTemplates.map(t => t.id === updatedTemplate.id ? updatedTemplate : t));
                };

                const handleAddItem = (categoryName) => {
                    const updatedTemplate = { ...selectedTemplate };
                    updatedTemplate.categories = updatedTemplate.categories.map(cat => {
                        if (cat.name === categoryName) {
                            return {
                                ...cat,
                                items: [...cat.items, { id: `${Date.now()}`, description: 'New sub-assessment item description', ref: '', assignedDepartment: 'All Departments' }]
                            };
                        }
                        return cat;
                    });
                    setSelectedTemplate(updatedTemplate);
                    setAssessmentTemplates(assessmentTemplates.map(t => t.id === updatedTemplate.id ? updatedTemplate : t));
                };

                const handleUpdateItem = (categoryName, itemId, field, value) => {
                    const updatedTemplate = { ...selectedTemplate };
                    updatedTemplate.categories = updatedTemplate.categories.map(cat => {
                        if (cat.name === categoryName) {
                            return {
                                ...cat,
                                items: cat.items.map(item =>
                                    item.id === itemId ? { ...item, [field]: value } : item
                                )
                            };
                        }
                        return cat;
                    });
                    setSelectedTemplate(updatedTemplate);
                    setAssessmentTemplates(assessmentTemplates.map(t => t.id === updatedTemplate.id ? updatedTemplate : t));
                };

                return (
                    <div className="p-8 bg-gray-50 flex-1 overflow-auto rounded-xl shadow-lg">
                        <h2 className="text-3xl font-extrabold text-gray-800 mb-6 border-b-2 pb-2 border-teal-500">Assessment Template Management</h2>

                        <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                            <h3 className="text-2xl font-semibold text-gray-800 mb-4">Template Operations</h3>
                            <div className="flex flex-wrap items-end gap-4 mb-6">
                                <div>
                                    <label htmlFor="new-template-year" className="block text-sm font-medium text-gray-700">New Template Year</label>
                                    <input
                                        type="number"
                                        id="new-template-year"
                                        className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm"
                                        value={newTemplateYear}
                                        onChange={(e) => setNewTemplateYear(e.target.value)}
                                        placeholder="e.g., 2025"
                                    />
                                </div>
                                <button
                                    onClick={() => setIsCreatingNewTemplate(true)}
                                    className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500"
                                >
                                    <PlusCircle size={18} className="mr-2" />
                                    Create New Assessment Template
                                </button>
                                <div className="ml-auto flex items-end gap-4">
                                    <div>
                                        <label htmlFor="copy-from-year" className="block text-sm font-medium text-gray-700">Copy Previous Year's Template</label>
                                        <select
                                            id="copy-from-year"
                                            className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm rounded-md"
                                            value={copiedTemplateYear}
                                            onChange={(e) => setCopiedTemplateYear(e.target.value)}
                                        >
                                            <option value="">Select Year</option>
                                            {assessmentTemplates.map(t => <option key={t.id} value={t.year}>{t.year}</option>)}
                                        </select>
                                    </div>
                                    <button
                                        onClick={handleCopyTemplate}
                                        className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                    >
                                        <Copy size={18} className="mr-2" />
                                        Copy Template
                                    </button>
                                </div>
                            </div>
                        </div>

                        {isCreatingNewTemplate && (
                            <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                                <h3 className="text-xl font-semibold text-gray-800 mb-4">New Template Confirmation</h3>
                                <p className="text-gray-700 mb-4">Are you sure you want to create a blank assessment template for <span className="font-bold">{newTemplateYear}</span>?</p>
                                <div className="flex gap-4">
                                    <button
                                        onClick={handleCreateTemplate}
                                        className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
                                    >
                                        Confirm Creation
                                    </button>
                                    <button
                                        onClick={() => setIsCreatingNewTemplate(false)}
                                        className="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        )}

                        <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                            <h3 className="text-2xl font-semibold text-gray-800 mb-4">Select and Edit Template</h3>
                            <select
                                className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm rounded-md mb-4"
                                value={selectedTemplate.id}
                                onChange={(e) => setSelectedTemplate(assessmentTemplates.find(t => t.id === e.target.value))}
                            >
                                {assessmentTemplates.map(template => (
                                    <option key={template.id} value={template.id}>{template.name}</option>
                                ))}
                            </select>

                            {selectedTemplate && (
                                <div className="border border-gray-200 p-6 rounded-lg bg-gray-50">
                                    <h4 className="text-xl font-bold text-gray-800 mb-4">{selectedTemplate.name}</h4>

                                    <div className="mb-6">
                                        <button
                                            onClick={() => handleDistributeTasks(selectedTemplate.id)}
                                            className="inline-flex items-center px-5 py-2 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500"
                                        >
                                            <Send size={20} className="mr-2" />
                                            Distribute Assessment Tasks to Departments
                                        </button>
                                        <p className="text-sm text-gray-500 mt-2">Click this button to distribute the template as annual assessment tasks and notify relevant departments.</p>
                                    </div>

                                    {selectedTemplate.categories.map((category, catIndex) => (
                                        <div key={category.name} className="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                                            <div className="flex items-center justify-between mb-3">
                                                <h5 className="text-lg font-semibold text-gray-800">{category.name}</h5>
                                                <div className="flex items-center gap-2">
                                                    <label className="text-sm font-medium text-gray-700">Weight:</label>
                                                    <input
                                                        type="number"
                                                        min="0"
                                                        max="100"
                                                        value={category.weight}
                                                        onChange={(e) => handleUpdateCategoryWeight(category.name, e.target.value)}
                                                        className="w-20 px-2 py-1 border border-gray-300 rounded-md text-sm text-center"
                                                    />
                                                    <span className="text-gray-600">%</span>
                                                </div>
                                            </div>
                                            {category.items.map((item, itemIndex) => (
                                                <div key={item.id} className="mb-4 p-3 border border-gray-100 rounded-md bg-gray-50">
                                                    <div className="flex flex-col gap-2">
                                                        <div>
                                                            <label className="block text-sm font-medium text-gray-700">Description:</label>
                                                            <textarea
                                                                value={item.description}
                                                                onChange={(e) => handleUpdateItem(category.name, item.id, 'description', e.target.value)}
                                                                className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm"
                                                                rows="2"
                                                            ></textarea>
                                                        </div>
                                                        <div className="flex items-center gap-4">
                                                            <div className="flex-1">
                                                                <label className="block text-sm font-medium text-gray-700">Internal/External Policy Reference:</label>
                                                                <input
                                                                    type="text"
                                                                    value={item.ref}
                                                                    onChange={(e) => handleUpdateItem(category.name, item.id, 'ref', e.target.value)}
                                                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm"
                                                                />
                                                            </div>
                                                            <button
                                                                onClick={() => { setModalContent(`Policy Details: ${item.ref || 'None'}`); setShowDetailModal(true); }}
                                                                className="px-3 py-2 bg-gray-200 text-gray-800 text-xs rounded-md hover:bg-gray-300"
                                                            >
                                                                View Details
                                                            </button>
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm font-medium text-gray-700">Assigned Department for Completion:</label>
                                                            <select
                                                                value={item.assignedDepartment}
                                                                onChange={(e) => handleUpdateItem(category.name, item.id, 'assignedDepartment', e.target.value)}
                                                                className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm rounded-md"
                                                            >
                                                                {departments.map(dept => <option key={dept} value={dept}>{dept}</option>)}
                                                            </select>
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm font-medium text-gray-700">Supporting Document Description Box:</label>
                                                            <textarea
                                                                value={`Please upload supporting documents related to "${item.description}".`} // Fixed dummy text for now
                                                                disabled
                                                                className="mt-1 block w-full px-3 py-2 border border-gray-200 rounded-md shadow-sm bg-gray-100 text-gray-600 sm:text-sm resize-none"
                                                                rows="1"
                                                            ></textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                            <button
                                                onClick={() => handleAddItem(category.name)}
                                                className="mt-3 inline-flex items-center px-4 py-2 border border-dashed border-teal-300 text-sm font-medium rounded-md text-teal-600 bg-teal-50 hover:bg-teal-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500"
                                            >
                                                <PlusCircle size={16} className="mr-2" />
                                                Add Sub-Assessment Item
                                            </button>
                                        </div>
                                    ))}

                                    <div className="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                                        <h5 className="text-lg font-semibold text-gray-800 mb-3">Annual Summary Questions (No Department Assignment Needed)</h5>
                                        {selectedTemplate.annualSummaryQuestions.map((q, index) => (
                                            <div key={index} className="mb-2">
                                                <input
                                                    type="text"
                                                    value={q}
                                                    disabled // For demonstration, assume these are fixed
                                                    className="mt-1 block w-full px-3 py-2 border border-gray-200 rounded-md shadow-sm bg-gray-100 text-gray-600 sm:text-sm"
                                                />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>

                        {showDetailModal && (
                            <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                                <div className="bg-white p-6 rounded-lg shadow-xl max-w-md w-full">
                                    <h3 className="text-lg font-bold mb-4">Policy Details</h3>
                                    <p className="text-gray-700 mb-6">{modalContent}</p>
                                    <button
                                        onClick={() => setShowDetailModal(false)}
                                        className="px-4 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700"
                                    >
                                        Close
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const RiskAssessmentFill = () => {
                const [selectedTask, setSelectedTask] = useState(null);
                const [taskData, setTaskData] = useState({});
                const [showSaveSuccess, setShowSaveSuccess] = useState(false);
                const [showSubmitConfirm, setShowSubmitConfirm] = useState(false);

                useEffect(() => {
                    if (selectedTask) {
                        setTaskData(selectedTask.data || {});
                    } else {
                        // Find the first 'Pending Completion' task for the current department, for demo purposes
                        const firstToDoTask = assessmentTasks.find(
                            task => task.department === 'Marketing Department' && (task.status === 'Pending Completion' || task.status === 'Rejected')
                        );
                        setSelectedTask(firstToDoTask);
                        setTaskData(firstToDoTask?.data || {});
                    }
                }, [selectedTask, assessmentTasks]);

                if (!selectedTask) {
                    return (
                        <div className="p-8 bg-gray-50 flex-1 overflow-auto rounded-xl shadow-lg">
                            <h2 className="text-3xl font-extrabold text-gray-800 mb-6 border-b-2 pb-2 border-teal-500">Risk Assessment Completion</h2>
                            <div className="bg-white p-6 rounded-lg shadow-md text-center text-gray-600">
                                <p className="mb-4">You currently have no risk assessment tasks pending completion.</p>
                                <p>Please contact the Risk Management Department to get new assessment tasks.</p>
                            </div>
                        </div>
                    );
                }

                const template = assessmentTemplates.find(t => t.id === selectedTask.templateId);
                if (!template) return <div className="p-8 bg-gray-50 flex-1 overflow-auto rounded-xl shadow-lg">Template not found.</div>;

                const handleScoreChange = (itemId, score) => {
                    setTaskData(prevData => ({
                        ...prevData,
                        [itemId]: { ...(prevData[itemId] || {}), score: parseInt(score) }
                    }));
                };

                const handleExplanationChange = (itemId, text) => {
                    setTaskData(prevData => ({
                        ...prevData,
                        [itemId]: { ...(prevData[itemId] || {}), explanation: text }
                    }));
                };

                const handleFileChange = (itemId, files) => {
                    setTaskData(prevData => ({
                        ...prevData,
                        [itemId]: { ...(prevData[itemId] || {}), files: Array.from(files).map(f => f.name) } // Store file names for simulation
                    }));
                };

                const handleAnnualSummaryChange = (index, text) => {
                    setTaskData(prevData => ({
                        ...prevData,
                        [`annual-summary-${index}`]: text
                    }));
                };

                const handleSave = () => {
                    setAssessmentTasks(prevTasks =>
                        prevTasks.map(task =>
                            task.id === selectedTask.id ? { ...task, data: taskData } : task
                        )
                    );
                    setShowSaveSuccess(true);
                    setTimeout(() => setShowSaveSuccess(false), 2000);
                    alert('Assessment content saved!');
                };

                const handleSubmit = () => {
                    setShowSubmitConfirm(false);
                    setAssessmentTasks(prevTasks =>
                        prevTasks.map(task => {
                            if (task.id === selectedTask.id) {
                                // When submitting, add current data to history
                                const updatedData = { ...taskData };
                                template.categories.forEach(category => {
                                    category.items.forEach(item => {
                                        if (updatedData[item.id]) {
                                            updatedData[item.id].history = [
                                                ...(updatedData[item.id].history || []),
                                                {
                                                    timestamp: new Date().toLocaleString(),
                                                    editor: 'ASSESSOR',
                                                    score: updatedData[item.id].score,
                                                    explanation: updatedData[item.id].explanation,
                                                    rmComment: updatedData[item.id].rmComment || ''
                                                }
                                            ];
                                        }
                                    });
                                });
                                return { ...task, data: updatedData, status: 'Submitted' };
                            }
                            return task;
                        })
                    );
                    alert('Assessment content submitted to Risk Management Department for review!');
                    setCurrentView('progressOverview'); // Go back to dashboard after submission
                };

                const taskItems = template.categories.flatMap(cat => cat.items).filter(item => item.assignedDepartment === selectedTask.department || item.assignedDepartment === 'All Departments');

                return (
                    <div className="p-8 bg-gray-50 flex-1 overflow-auto rounded-xl shadow-lg">
                        <h2 className="text-3xl font-extrabold text-gray-800 mb-6 border-b-2 pb-2 border-teal-500">Risk Assessment Completion</h2>

                        <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                            <h3 className="text-2xl font-semibold text-gray-800 mb-4">
                                {selectedTask.year} {selectedTask.riskType} Risk Assessment - {selectedTask.department}
                            </h3>
                            <p className="text-sm text-gray-600 mb-4">Current Status: <span className={`font-semibold ${
                                selectedTask.status === 'Pending Completion' ? 'text-gray-800' :
                                selectedTask.status === 'Rejected' ? 'text-red-600' :
                                ''
                            }`}>{selectedTask.status}</span></p>

                            {selectedTask.status === 'Rejected' && selectedTask.comments.length > 0 && (
                                <div className="bg-red-50 border border-red-200 text-red-800 p-4 rounded-lg mb-6">
                                    <h4 className="font-semibold text-lg flex items-center mb-2"><XCircle size={20} className="mr-2" /> Rejection Comments:</h4>
                                    {selectedTask.comments.map((comment, idx) => (
                                        <p key={idx} className="text-sm">{comment.text} <span className="text-gray-500 text-xs">({comment.timestamp})</span></p>
                                    ))}
                                </div>
                            )}

                            <div className="flex justify-end gap-3 mb-6">
                                <button
                                    onClick={() => alert('Download assessment form functionality pending implementation')}
                                    className="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500"
                                >
                                    <Download size={18} className="mr-2" />
                                    Download Assessment Form (Excel)
                                </button>
                                <button
                                    onClick={handleSave}
                                    className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                >
                                    <Save size={18} className="mr-2" />
                                    Save
                                </button>
                                <button
                                    onClick={() => setShowSubmitConfirm(true)}
                                    className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500"
                                >
                                    <Send size={18} className="mr-2" />
                                    Submit
                                </button>
                            </div>

                            {showSaveSuccess && (
                                <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
                                    <strong className="font-bold">Success!</strong>
                                    <span className="block sm:inline ml-2">Assessment content saved.</span>
                                </div>
                            )}

                            {template.categories.map(category => (
                                <div key={category.name} className="mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50 shadow-sm">
                                    <h5 className="text-lg font-semibold text-gray-800 mb-3">{category.name} ({category.weight}%)</h5>
                                    {category.items
                                        .filter(item => item.assignedDepartment === selectedTask.department || item.assignedDepartment === 'All Departments')
                                        .map(item => (
                                            <div key={item.id} className="mb-4 p-3 border border-gray-100 rounded-md bg-white">
                                                <p className="font-medium text-gray-800 mb-2">{item.description}</p>
                                                <p className="text-sm text-gray-600 mb-2">Policy Reference: {item.ref}</p>
                                                <div className="mb-3">
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Score (5-1 points):</label>
                                                    <select
                                                        value={taskData[item.id]?.score || ''}
                                                        onChange={(e) => handleScoreChange(item.id, e.target.value)}
                                                        className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm rounded-md"
                                                    >
                                                        <option value="">Please select</option>
                                                        {[5, 4, 3, 2, 1].map(score => <option key={score} value={score}>{score} points</option>)}
                                                    </select>
                                                </div>
                                                <div className="mb-3">
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Explanation Text:</label>
                                                    <textarea
                                                        value={taskData[item.id]?.explanation || ''}
                                                        onChange={(e) => handleExplanationChange(item.id, e.target.value)}
                                                        className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm"
                                                        rows="3"
                                                        placeholder="Please provide detailed explanation..."
                                                    ></textarea>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Upload Supporting Documents:</label>
                                                    <input
                                                        type="file"
                                                        multiple
                                                        onChange={(e) => handleFileChange(item.id, e.target.files)}
                                                        className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100"
                                                    />
                                                    {taskData[item.id]?.files && taskData[item.id]?.files.length > 0 && (
                                                        <div className="text-xs text-gray-500 mt-1">Uploaded: {taskData[item.id].files.join(', ')}</div>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                </div>
                            ))}

                            {/* Annual Summary */}
                            <div className="mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50 shadow-sm">
                                <h5 className="text-lg font-semibold text-gray-800 mb-3">Annual Summary</h5>
                                {template.annualSummaryQuestions.map((question, index) => (
                                    <div key={`summary-${index}`} className="mb-3">
                                        <label className="block text-sm font-medium text-gray-700 mb-1">{question}:</label>
                                        <textarea
                                            value={taskData[`annual-summary-${index}`] || ''}
                                            onChange={(e) => handleAnnualSummaryChange(index, e.target.value)}
                                            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm"
                                            rows="3"
                                            placeholder={`Please fill in ${question.replace('Annual', '')} for this year...`}
                                        ></textarea>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {showSubmitConfirm && (
                            <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                                <div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                                    <h3 className="text-lg font-bold mb-4">Confirm Submission</h3>
                                    <p className="text-gray-700 mb-6">Are you sure you want to submit this risk assessment? It will be forwarded to the Risk Management Department for review.</p>
                                    <div className="flex justify-end gap-4">
                                        <button
                                            onClick={() => setShowSubmitConfirm(false)}
                                            className="px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            onClick={handleSubmit}
                                            className="px-4 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 text-sm font-medium"
                                        >
                                            Confirm Submission
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const RiskAssessmentReview = () => {
                const [selectedTask, setSelectedTask] = useState(null);
                const [reviewData, setReviewData] = useState({}); // State for RM's edits and comments
                const [showSaveSuccess, setShowSaveSuccess] = useState(false);
                const [editingItemId, setEditingItemId] = useState(null); // New state for editing specific item
                const [showHistoryModal, setShowHistoryModal] = useState(false);
                const [historyContent, setHistoryContent] = useState([]);

                useEffect(() => {
                    if (selectedTask) {
                        // Initialize reviewData with a deep copy of selectedTask.data
                        setReviewData(JSON.parse(JSON.stringify(selectedTask.data || {})));
                    } else {
                        const firstSubmittedTask = assessmentTasks.find(task => task.status === 'Submitted' || task.status === 'Rejected');
                        setSelectedTask(firstSubmittedTask);
                        setReviewData(JSON.parse(JSON.stringify(firstSubmittedTask?.data || {})));
                    }
                }, [selectedTask, assessmentTasks]);

                const handleReviewScoreChange = (itemId, score) => {
                    setReviewData(prevData => ({
                        ...prevData,
                        [itemId]: { ...(prevData[itemId] || {}), score: parseInt(score) }
                    }));
                };

                const handleReviewExplanationChange = (itemId, text) => {
                    setReviewData(prevData => ({
                        ...prevData,
                        [itemId]: { ...(prevData[itemId] || {}), explanation: text }
                    }));
                };

                const handleReviewCommentChange = (itemId, text) => {
                    setReviewData(prevData => ({
                        ...prevData,
                        [itemId]: { ...(prevData[itemId] || {}), rmComment: text }
                    }));
                };

                const handleReviewAnnualSummaryChange = (index, text) => {
                    setReviewData(prevData => ({
                        ...prevData,
                        [`annual-summary-${index}`]: text
                    }));
                };

                const handleSaveReview = () => {
                    setAssessmentTasks(prevTasks =>
                        prevTasks.map(task =>
                            task.id === selectedTask.id ? { ...task, data: reviewData } : task
                        )
                    );
                    setShowSaveSuccess(true);
                    setTimeout(() => setShowSaveSuccess(false), 2000);
                    alert('Review content saved!');
                };

                const handleSaveItemEdit = (itemId) => {
                    // Add current edited state to history
                    const currentItemData = reviewData[itemId];
                    const updatedHistory = [
                        ...(currentItemData.history || []),
                        {
                            timestamp: new Date().toLocaleString(),
                            editor: 'RM',
                            score: currentItemData.score,
                            explanation: currentItemData.explanation,
                            rmComment: currentItemData.rmComment || ''
                        }
                    ];

                    setReviewData(prevData => ({
                        ...prevData,
                        [itemId]: {
                            ...prevData[itemId],
                            history: updatedHistory
                        }
                    }));
                    setEditingItemId(null); // Exit editing mode
                    handleSaveReview(); // Also save the overall review data
                };

                const handleCancelItemEdit = () => {
                    setEditingItemId(null); // Exit editing mode
                    // Revert changes for this item by re-initializing reviewData from selectedTask
                    setReviewData(JSON.parse(JSON.stringify(selectedTask.data || {})));
                };

                const handleSubmitReviewAsRejected = () => {
                    const newComments = [...selectedTask.comments];
                    if (!newComments.some(c => c.from === 'RM' && c.text.includes('Rejected'))) {
                        newComments.push({ from: 'RM', text: 'Reviewed and rejected.', timestamp: new Date().toLocaleString() });
                    }

                    setAssessmentTasks(prevTasks =>
                        prevTasks.map(task =>
                            task.id === selectedTask.id
                                ? { ...task, data: reviewData, status: 'Rejected', comments: newComments }
                                : task
                        )
                    );
                    alert(`Task submitted as rejected, and ${selectedTask.department} has been notified.`);
                    setSelectedTask(null); // Clear selected task to pick next one
                };

                const handleCompleteReview = () => {
                    setAssessmentTasks(prevTasks =>
                        prevTasks.map(task =>
                            task.id === selectedTask.id ? { ...task, data: reviewData, status: 'Reviewed', comments: [...task.comments, { from: 'RM', text: 'Review passed.', timestamp: new Date().toLocaleString() }] } : task
                        )
                    );
                    alert('Review completed!');
                    setSelectedTask(null); // Clear selected task to pick next one
                };

                const handleViewHistory = (itemId) => {
                    const itemHistory = reviewData[itemId]?.history || [];
                    setHistoryContent(itemHistory);
                    setShowHistoryModal(true);
                };

                const submittedTasks = assessmentTasks.filter(t => t.status === 'Submitted' || t.status === 'Rejected');

                return (
                    <div className="p-8 bg-gray-50 flex-1 overflow-auto rounded-xl shadow-lg">
                        <h2 className="text-3xl font-extrabold text-gray-800 mb-6 border-b-2 pb-2 border-teal-500">Risk Assessment Review</h2>

                        <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                            <h3 className="text-2xl font-semibold text-gray-800 mb-4">Pending Review Tasks List</h3>
                            <select
                                className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm rounded-md mb-4"
                                value={selectedTask?.id || ''}
                                onChange={(e) => setSelectedTask(submittedTasks.find(t => t.id === e.target.value))}
                            >
                                <option value="">Select a task for review</option>
                                {submittedTasks.map(task => (
                                    <option key={task.id} value={task.id}>
                                        {task.year} {task.riskType} - {task.department} ({task.status})
                                    </option>
                                ))}
                            </select>
                        </div>

                        {selectedTask && (
                            <div className="bg-white p-6 rounded-lg shadow-md">
                                <h3 className="text-2xl font-semibold text-gray-800 mb-4">
                                    Review Task: {selectedTask.year} {selectedTask.riskType} - {selectedTask.department}
                                </h3>
                                <p className="text-sm text-gray-600 mb-4">Current Status: <span className={`font-semibold ${
                                    selectedTask.status === 'Submitted' ? 'text-blue-600' :
                                    selectedTask.status === 'Rejected' ? 'text-red-600' :
                                    ''
                                }`}>{selectedTask.status}</span></p>

                                {selectedTask.comments.length > 0 && (
                                    <div className="bg-gray-100 p-4 rounded-lg mb-6">
                                        <h4 className="font-semibold text-lg flex items-center mb-2"><MessageSquareText size={20} className="mr-2" /> Historical Comments:</h4>
                                        {selectedTask.comments.map((comment, idx) => (
                                            <p key={idx} className="text-sm text-gray-700">{comment.from}: {comment.text} <span className="text-gray-500 text-xs">({comment.timestamp})</span></p>
                                        ))}
                                    </div>
                                )}

                                {showSaveSuccess && (
                                    <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
                                        <strong className="font-bold">Success!</strong>
                                        <span className="block sm:inline ml-2">Review content saved.</span>
                                    </div>
                                )}

                                {assessmentTemplates.find(t => t.id === selectedTask.templateId)?.categories.map(category => (
                                    <div key={category.name} className="mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50 shadow-sm">
                                        <h5 className="text-lg font-semibold text-gray-800 mb-3">{category.name} ({category.weight}%)</h5>
                                        {category.items
                                            .filter(item => item.assignedDepartment === selectedTask.department || item.assignedDepartment === 'All Departments')
                                            .map(item => (
                                                <div key={item.id} className="mb-4 p-3 border border-gray-100 rounded-md bg-white">
                                                    <p className="font-medium text-gray-800 mb-2">{item.description}</p>
                                                    <p className="text-sm text-gray-600 mb-2">Policy Reference: {item.ref}</p>

                                                    {editingItemId === item.id ? (
                                                        // Editing mode
                                                        <>
                                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                                <div>
                                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Assessor Score:</label>
                                                                    <select
                                                                        value={reviewData[item.id]?.score || ''}
                                                                        onChange={(e) => handleReviewScoreChange(item.id, e.target.value)}
                                                                        className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm rounded-md"
                                                                    >
                                                                        <option value="">Please select</option>
                                                                        {[5, 4, 3, 2, 1].map(score => <option key={score} value={score}>{score} points</option>)}
                                                                    </select>
                                                                </div>
                                                                <div>
                                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Supporting Documents:</label>
                                                                    <span className="block p-2 border border-gray-300 rounded-md bg-gray-100 text-gray-900">
                                                                        {(selectedTask.data[item.id]?.files?.length > 0 ? selectedTask.data[item.id].files.join(', ') : 'None')}
                                                                    </span>
                                                                </div>
                                                            </div>
                                                            <div className="mt-3">
                                                                <label className="block text-sm font-medium text-gray-700 mb-1">Assessor Explanation Text:</label>
                                                                <textarea
                                                                    value={reviewData[item.id]?.explanation || ''}
                                                                    onChange={(e) => handleReviewExplanationChange(item.id, e.target.value)}
                                                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm resize-none"
                                                                    rows="3"
                                                                ></textarea>
                                                            </div>
                                                            <div className="mt-3">
                                                                <label className="block text-sm font-medium text-gray-700 mb-1">RM Comment:</label>
                                                                <textarea
                                                                    value={reviewData[item.id]?.rmComment || ''}
                                                                    onChange={(e) => handleReviewCommentChange(item.id, e.target.value)}
                                                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm resize-none"
                                                                    rows="2"
                                                                    placeholder="Add your comment..."
                                                                ></textarea>
                                                            </div>
                                                            <div className="flex gap-2 mt-4">
                                                                <button
                                                                    onClick={() => handleSaveItemEdit(item.id)}
                                                                    className="inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
                                                                >
                                                                    <Save size={16} className="mr-1" /> Save
                                                                </button>
                                                                <button
                                                                    onClick={handleCancelItemEdit}
                                                                    className="inline-flex items-center px-3 py-1.5 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500"
                                                                >
                                                                    Cancel
                                                                </button>
                                                            </div>
                                                        </>
                                                    ) : (
                                                        // Display mode
                                                        <>
                                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                                <div>
                                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Assessor Score:</label>
                                                                    <span className="block p-2 border border-gray-300 rounded-md bg-gray-100 text-gray-900 font-bold">
                                                                        {reviewData[item.id]?.score || 'Not filled'} points
                                                                    </span>
                                                                </div>
                                                                <div>
                                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Supporting Documents:</label>
                                                                    <span className="block p-2 border border-gray-300 rounded-md bg-gray-100 text-gray-900">
                                                                        {(selectedTask.data[item.id]?.files?.length > 0 ? selectedTask.data[item.id].files.join(', ') : 'None')}
                                                                    </span>
                                                                </div>
                                                            </div>
                                                            <div className="mt-3">
                                                                <label className="block text-sm font-medium text-gray-700 mb-1">Assessor Explanation Text:</label>
                                                                <textarea
                                                                    value={reviewData[item.id]?.explanation || 'Not filled'}
                                                                    disabled
                                                                    className="mt-1 block w-full px-3 py-2 border border-gray-200 rounded-md bg-gray-100 text-gray-800 sm:text-sm resize-none"
                                                                    rows="3"
                                                                ></textarea>
                                                            </div>
                                                            <div className="mt-3">
                                                                <label className="block text-sm font-medium text-gray-700 mb-1">RM Comment:</label>
                                                                <textarea
                                                                    value={reviewData[item.id]?.rmComment || 'None'}
                                                                    disabled
                                                                    className="mt-1 block w-full px-3 py-2 border border-gray-200 rounded-md bg-gray-100 text-gray-800 sm:text-sm resize-none"
                                                                    rows="2"
                                                                ></textarea>
                                                            </div>
                                                            <div className="flex gap-2 mt-4">
                                                                <button
                                                                    onClick={() => setEditingItemId(item.id)}
                                                                    className="inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500"
                                                                >
                                                                    <Edit size={16} className="mr-1" /> Edit
                                                                </button>
                                                                <button
                                                                    onClick={() => handleViewHistory(item.id)}
                                                                    className="inline-flex items-center px-3 py-1.5 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500"
                                                                >
                                                                    <RefreshCcw size={16} className="mr-1" /> View History
                                                                </button>
                                                            </div>
                                                        </>
                                                    )}
                                                </div>
                                            ))}
                                    </div>
                                ))}

                                {/* Annual Summary for review */}
                                <div className="mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50 shadow-sm">
                                    <h5 className="text-lg font-semibold text-gray-800 mb-3">Annual Summary</h5>
                                    {assessmentTemplates.find(t => t.id === selectedTask.templateId)?.annualSummaryQuestions.map((question, index) => (
                                        <div key={`summary-review-${index}`} className="mb-3">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">{question}:</label>
                                            <textarea
                                                value={reviewData[`annual-summary-${index}`] || ''}
                                                onChange={(e) => handleReviewAnnualSummaryChange(index, e.target.value)}
                                                className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm resize-none"
                                                rows="3"
                                            ></textarea>
                                        </div>
                                    ))}
                                </div>

                                <div className="flex justify-end gap-3 mt-6">
                                    <button
                                        onClick={handleSaveReview}
                                        className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                    >
                                        <Save size={18} className="mr-2" />
                                        Save
                                    </button>
                                    <button
                                        onClick={handleSubmitReviewAsRejected}
                                        className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-orange-500 hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500"
                                    >
                                        <Send size={18} className="mr-2" />
                                        Submit (Reject)
                                    </button>
                                    <button
                                        onClick={handleCompleteReview}
                                        className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
                                    >
                                        <CheckCircle size={18} className="mr-2" />
                                        Complete Review
                                    </button>
                                </div>
                            </div>
                        )}

                        {showHistoryModal && (
                            <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                                <div className="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                                    <h3 className="text-lg font-bold mb-4">Assessment Content History</h3>
                                    {historyContent.length === 0 ? (
                                        <p className="text-gray-600">No history records.</p>
                                    ) : (
                                        <div className="space-y-4">
                                            {historyContent.map((record, index) => (
                                                <div key={index} className="border border-gray-200 p-4 rounded-md bg-gray-50">
                                                    <p className="text-sm font-semibold text-gray-800 mb-2">
                                                        Version {index + 1} - {record.timestamp} (Editor: {record.editor === 'RM' ? 'Risk Management Department' : 'Assessment Department'})
                                                    </p>
                                                    <p className="text-sm text-gray-700">Score: <span className="font-bold">{record.score || 'Not filled'}</span></p>
                                                    <p className="text-sm text-gray-700">Explanation: {record.explanation || 'None'}</p>
                                                    {record.rmComment && (
                                                        <p className="text-sm text-blue-700">RM Comment: {record.rmComment}</p>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    <button
                                        onClick={() => setShowHistoryModal(false)}
                                        className="mt-6 px-4 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700"
                                    >
                                        Close
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const ProgressOverview = () => {
                const [selectedDepartment, setSelectedDepartment] = useState('Legal Department'); // Default for assessor

                const getCategoryStatus = (taskData, categoryItems) => {
                    if (!taskData || Object.keys(taskData).length === 0) return 'Pending Completion';
                    // For progress overview, we consider an item "filled" if it has a score and explanation.
                    // RM comments are separate and don't affect "filled" status for the assessor's view.
                    const itemsToFill = categoryItems.filter(item => selectedTask?.department === item.assignedDepartment || item.assignedDepartment === 'All Departments');
                    const filledItems = itemsToFill.filter(item => taskData[item.id]?.score && taskData[item.id]?.explanation);

                    if (filledItems.length === itemsToFill.length && itemsToFill.length > 0) return 'Completed';
                    if (filledItems.length > 0) return 'Partially Completed';
                    return 'Pending Completion';
                };


                const calculateTaskCategoryCompletion = (task) => {
                    const template = assessmentTemplates.find(t => t.id === task.templateId);
                    if (!template) return {};

                    const categoryCompletion = {};
                    template.categories.forEach(category => {
                        const relevantItems = category.items.filter(item => item.assignedDepartment === task.department || item.assignedDepartment === 'All Departments');
                        if (relevantItems.length === 0) {
                            categoryCompletion[category.name] = 'N/A';
                            return;
                        }

                        let filledCount = 0;
                        relevantItems.forEach(item => {
                            if (task.data[item.id]?.score && task.data[item.id]?.explanation) {
                                filledCount++;
                            }
                        });

                        if (task.status === 'Reviewed') {
                            categoryCompletion[category.name] = 'Reviewed';
                        } else if (task.status === 'Rejected') {
                            categoryCompletion[category.name] = 'Rejected';
                        } else if (filledCount === relevantItems.length) {
                            categoryCompletion[category.name] = 'Submitted';
                        } else if (filledCount > 0) {
                            categoryCompletion[category.name] = 'Partially Completed';
                        } else {
                            categoryCompletion[category.name] = 'Pending Completion';
                        }
                    });
                    return categoryCompletion;
                };

                const departmentProgressData = {};
                departments.forEach(dept => {
                    const deptTasks = assessmentTasks.filter(task => task.department === dept);
                    const totalTasks = deptTasks.length;
                    const completedTasks = deptTasks.filter(task => task.status === 'Reviewed').length;
                    departmentProgressData[dept] = {
                        progress: totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0,
                        tasks: deptTasks,
                    };
                });


                // Global view data preparation (RM)
                const globalProgressMatrix = {};
                riskTypes.forEach(rType => {
                    globalProgressMatrix[rType] = {};
                    departments.forEach(dept => {
                        const task = assessmentTasks.find(t => t.riskType === rType && t.department === dept);
                        globalProgressMatrix[rType][dept] = task ? task.status : 'Not Started';
                    });
                });

                const getStatusColorClass = (status) => {
                    switch (status) {
                        case 'Pending Completion': return 'bg-gray-200 text-gray-800';
                        case 'Submitted': return 'bg-blue-200 text-blue-800';
                        case 'Rejected': return 'bg-red-200 text-red-800';
                        case 'Reviewed': return 'bg-green-200 text-green-800';
                        case 'Not Started': return 'bg-gray-100 text-gray-500';
                        default: return 'bg-gray-200 text-gray-800';
                    }
                };

                const renderDepartmentView = () => {
                    const myTasks = assessmentTasks.filter(task => task.department === selectedDepartment);
                    const myTotalProgress = getDepartmentProgress(selectedDepartment);

                    return (
                        <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                            <h3 className="text-2xl font-semibold text-gray-800 mb-4">My Assessment Progress ({selectedDepartment})</h3>
                            <div className="flex items-center mb-6">
                                <span className="text-lg font-medium text-gray-700 mr-4">Overall Completion:</span>
                                <div className="w-full bg-gray-200 rounded-full h-6">
                                    <div
                                        className="bg-teal-600 h-6 rounded-full text-xs flex items-center justify-center text-white"
                                        style={{ width: `${myTotalProgress}%` }}
                                    >
                                        {myTotalProgress}%
                                    </div>
                                </div>
                            </div>

                            <div className="overflow-x-auto rounded-lg shadow">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assessment Year</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Risk Category</th>
                                            {assessmentCategories.map(cat => (
                                                <th key={cat} className="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">{cat}</th>
                                            ))}
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Overall Status</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {myTasks.length === 0 ? (
                                            <tr>
                                                <td colSpan={assessmentCategories.length + 3} className="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                                                    No Assessment Tasks
                                                </td>
                                            </tr>
                                        ) : (
                                            myTasks.map(task => {
                                                const categoryStatus = calculateTaskCategoryCompletion(task);
                                                return (
                                                    <tr key={task.id}>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{task.year}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{task.riskType}</td>
                                                        {assessmentCategories.map(cat => (
                                                            <td key={cat} className="px-3 py-4 whitespace-nowrap text-center text-sm">
                                                                <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColorClass(categoryStatus[cat] || 'Pending Completion')}`}>
                                                                    {categoryStatus[cat] || 'Pending Completion'}
                                                                </span>
                                                            </td>
                                                        ))}
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm">
                                                            <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColorClass(task.status)}`}>
                                                                {task.status}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                );
                                            })
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    );
                };

                const renderRMView = () => (
                    <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                        <h3 className="text-2xl font-semibold text-gray-800 mb-4">Global Assessment Progress Overview</h3>
                        <div className="flex items-center mb-6">
                            <span className="text-lg font-medium text-gray-700 mr-4">Overall Completion:</span>
                            <div className="w-full bg-gray-200 rounded-full h-6">
                                <div
                                    className="bg-teal-600 h-6 rounded-full text-xs flex items-center justify-center text-white"
                                    style={{ width: `${getOverallProgress()}%` }}
                                >
                                    {getOverallProgress()}%
                                </div>
                            </div>
                        </div>

                        <div className="mb-4">
                            <h4 className="text-lg font-semibold text-gray-800 mb-2">Legend:</h4>
                            <div className="flex flex-wrap gap-4">
                                <div className="flex items-center">
                                    <span className="w-6 h-6 rounded-md bg-gray-200 mr-2"></span>
                                    <span className="text-sm text-gray-700">Pending Completion</span>
                                </div>
                                <div className="flex items-center">
                                    <span className="w-6 h-6 rounded-md bg-blue-200 mr-2"></span>
                                    <span className="text-sm text-gray-700">Submitted</span>
                                </div>
                                <div className="flex items-center">
                                    <span className="w-6 h-6 rounded-md bg-red-200 mr-2"></span>
                                    <span className="text-sm text-gray-700">Rejected</span>
                                </div>
                                <div className="flex items-center">
                                    <span className="w-6 h-6 rounded-md bg-green-200 mr-2"></span>
                                    <span className="text-sm text-gray-700">Reviewed</span>
                                </div>
                                <div className="flex items-center">
                                    <span className="w-6 h-6 rounded-md bg-gray-100 mr-2"></span>
                                    <span className="text-sm text-gray-700">Not Started (No tasks)</span>
                                </div>
                            </div>
                        </div>

                        <div className="overflow-x-auto rounded-lg shadow">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Risk Type \ Department</th>
                                        {departments.map(dept => (
                                            <th key={dept} className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">{dept}</th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {riskTypes.map(rType => (
                                        <tr key={rType}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{rType}</td>
                                            {departments.map(dept => (
                                                <td key={dept} className="px-6 py-4 whitespace-nowrap text-center text-sm">
                                                    <span className={`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColorClass(globalProgressMatrix[rType]?.[dept] || 'Not Started')}`}>
                                                        {globalProgressMatrix[rType]?.[dept] || 'Not Started'}
                                                    </span>
                                                </td>
                                            ))}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );

                return (
                    <div className="p-8 bg-gray-50 flex-1 overflow-auto rounded-xl shadow-lg">
                        <h2 className="text-3xl font-extrabold text-gray-800 mb-6 border-b-2 pb-2 border-teal-500">Assessment Progress Overview</h2>

                        {/* Dashboard content moved here */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                            <div className="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                                <div>
                                    <p className="text-sm font-medium text-gray-500">Total Current Tasks</p>
                                    <p className="text-3xl font-bold text-gray-900">{assessmentTasks.length}</p>
                                </div>
                                <ClipboardList size={48} className="text-teal-500 opacity-60" />
                            </div>
                            <div className="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                                <div>
                                    <p className="text-sm font-medium text-gray-500">Tasks Pending Action</p>
                                    <p className="text-3xl font-bold text-red-500">{assessmentTasks.filter(t => t.status === 'Pending Completion' || t.status === 'Submitted' || t.status === 'Rejected').length}</p>
                                </div>
                                <Clock size={48} className="text-red-500 opacity-60" />
                            </div>
                            <div className="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                                <div>
                                    <p className="text-sm font-medium text-gray-500">Overall Assessment Progress</p>
                                    <p className="text-3xl font-bold text-green-600">{getOverallProgress()}%</p>
                                </div>
                                <BarChart3 size={48} className="text-green-600 opacity-60" />
                            </div>
                        </div>

                        {userRole === 'RM' && (
                            <div className="mb-6 bg-yellow-50 border border-yellow-200 text-yellow-800 p-4 rounded-lg flex items-start">
                                <CheckCircle size={20} className="mr-3 mt-1" />
                                <div>
                                    <h4 className="font-semibold text-lg mb-1">Review Task Reminder:</h4>
                                    <p className="text-sm">You have <span className="font-bold text-yellow-700">{assessmentTasks.filter(t => t.status === 'Submitted').length}</span> risk assessment tasks awaiting review.</p>
                                    <button
                                        onClick={() => setCurrentView('riskAssessmentReview')}
                                        className="mt-3 inline-flex items-center px-4 py-2 bg-yellow-600 text-white text-sm font-medium rounded-md hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2"
                                    >
                                        Go to Review Now
                                        <ChevronRight size={16} className="ml-2" />
                                    </button>
                                </div>
                            </div>
                        )}
                        {userRole === 'ASSESSOR' && (
                            <div className="mb-6 bg-blue-50 border border-blue-200 text-blue-800 p-4 rounded-lg flex items-start">
                                <ClipboardList size={20} className="mr-3 mt-1" />
                                <div>
                                    <h4 className="font-semibold text-lg mb-1">To-Do Notification:</h4>
                                    <p className="text-sm">You have <span className="font-bold text-blue-700">{assessmentTasks.filter(t => t.department === 'Marketing Department' && t.status === 'Pending Completion').length}</span> new risk assessment tasks to complete.</p>
                                    <button
                                        onClick={() => setCurrentView('riskAssessmentFill')}
                                        className="mt-3 inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                                    >
                                        Go to Complete Now
                                        <ChevronRight size={16} className="ml-2" />
                                    </button>
                                </div>
                            </div>
                        )}
                        {/* End Dashboard content moved here */}

                        {userRole === 'RM' ? renderRMView() : renderDepartmentView()}
                    </div>
                );
            };


            const renderContent = () => {
                switch (currentView) {
                    case 'historicalReports':
                        return <HistoricalReports />;
                    case 'heatmapRecords':
                        return <RiskHeatmapRecords />;
                    case 'templateManagement':
                        return userRole === 'RM' ? <AssessmentTemplateManagement /> : <RestrictedAccess />;
                    case 'riskAssessmentFill':
                        return <RiskAssessmentFill />;
                    case 'riskAssessmentReview':
                        return userRole === 'RM' ? <RiskAssessmentReview /> : <RestrictedAccess />;
                    case 'progressOverview':
                        return <ProgressOverview />;
                    default:
                        return <ProgressOverview />; // Default to ProgressOverview
                }
            };

            const RestrictedAccess = () => (
                <div className="p-8 bg-gray-50 flex-1 overflow-auto rounded-xl shadow-lg flex items-center justify-center">
                    <div className="bg-white p-8 rounded-lg shadow-md text-center">
                        <XCircle size={60} className="text-red-500 mx-auto mb-4" />
                        <h3 className="text-2xl font-bold text-gray-800 mb-2">Access Restricted</h3>
                        <p className="text-gray-600">You do not have permission to access this page.</p>
                    </div>
                </div>
            );

            return (
                <div className="flex h-screen bg-gray-100 font-sans">
                    <Sidebar />
                    <main className="flex-1 p-4 overflow-y-auto"> {/* Added overflow-y-auto here */}
                        {renderContent()}
                    </main>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
